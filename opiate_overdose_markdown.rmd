---
title: "MUSA 507 Final Project: Predicting Heroin Overdose Events in Cincinnati, OH"
author: "Claire Allen-Platt and Nicolas Corona"
date: "December 20, 2019"
output:  
  html_document#:
    toc: TRUE
    toc_float: true
    code_folding: hide
    theme: united
  
---
```{r setup, include = TRUE}
knitr::opts_chunk$set(echo = TRUE, results = TRUE, message = FALSE, 
                      warning = FALSE, fig.align="center", cache=FALSE)
```

```{r load, results="hide"}

######################################################################################
##############################################
# Load packages, palettes, functions, themes #
##############################################
######################################################################################

library(here)
library(tidyverse)
library(dplyr)
library(janitor)
library(cowplot)
library(maps)
library(tools)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(QuantPsyc)
library(RSocrata)
library(viridis)
library(caret)
library(spatstat)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(stringr)
library(lubridate)
library(raster)
census_api_key("f4a1e79b1b513acf5523856785193ebfdecdd406")

# Themes and palettes
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}
palette_5_blOr <-  c("#1170AA","#5FA2CE","#A3CCE9","#FC7D0B","#C85200")

# Functions
nn_function <- function(measureFrom,measureTo,k) {
  measureFrom_Matrix <-
    as.matrix(measureFrom)
  measureTo_Matrix <-
    as.matrix(measureTo)
  nn <-   
    get.knnx(measureTo, measureFrom, k)$nn.dist
  output <-
    as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>% 
    dplyr::select(-thisPoint) %>%
    pull()
  
  return(output)  
}

######################################################################################
##########################
# Load data from online. #
##########################
######################################################################################

# ems <- read.socrata("https://data.cincinnati-oh.gov/resource/vnsz-a3wp.csv") 
# saveRDS(ems, "ems.RDS")
#
# drugs_cops <- read.socrata("https://data.cincinnati-oh.gov/resource/3gx7-se9a.csv")
# saveRDS(drugs_cops, "drugs_cops.RDS")
#
# heroin_cops <- read.socrata("https://data.cincinnati-oh.gov/resource/7mtn-nnb5.csv")
# saveRDS(heroin_cops, "heroin_cops.RDS")
#
# cops <- read.socrata("https://data.cincinnati-oh.gov/resource/gexm-h6bt.csv")
# saveRDS(cops, "cops.RDS")
# 
# crimes <- read.socrata("https://data.cincinnati-oh.gov/resource/k59e-2pvf.csv")
# saveRDS(crimes, "crimes.RDS")
# 
# c311 <- read.socrata("https://data.cincinnati-oh.gov/resource/4cjh-bm8b.csv")
# saveRDS(c311, "c311.RDS")
# 
# code <- read.socrata("https://data.cincinnati-oh.gov/resource/cncm-znd6.csv")
# saveRDS(code, "code.RDS")
# 
# cincinnati <- st_read("https://opendata.arcgis.com/datasets/ed78f4754b044ac5815d0a9efe9bb336_1.geojson") # Cincinnati city boundary shapefile.
# saveRDS(cincinnati, "cincinnati.RDS")
# 
# sna <- st_read("https://opendata.arcgis.com/datasets/572561553c9e4d618d2d7939c5261d46_0.geojson")
# saveRDS(sna, "sna.RDS")
# 
# districts_cops <- st_read("https://opendata.arcgis.com/datasets/9bc1afaff72e4f44a6d19280c159c951_4.geojson")
# saveRDS(districts_cops, "districts_cops.RDS")
# 
# firehouses <- st_read("https://opendata.arcgis.com/datasets/a6f043d181f94e37a274975a3718b7af_16.geojson")
# saveRDS(firehouses, "firehouses.RDS")
# 
# sheriff <- st_read("https://opendata.arcgis.com/datasets/ad2bd178b8624b04ae1878fe598c6001_3.geojson")
# saveRDS(sheriff, "sheriff.RDS")
# 
# zoning <- st_read("https://opendata.arcgis.com/datasets/b43c6f6671d54da298fd6110a3088557_11.geojson")
# saveRDS(zoning, "zoning.RDS")
# 
# bus stops
# transit_stops <- st_read("https://opendata.arcgis.com/datasets/e2bfcf84442f4ae5be46208f95b49942_1.geojson")
# saveRDS(transit_stops, "transit_stops.RDS")
# 
# # Census data
# # Race from the 2010 US Census
# racevars <- c(total_pop = "P003001",
#               white = "P003002", 
#               black = "P003003", 
#               asian = "P003005", 
#               hispanic = "P004003",
#               two_or_more = "P003008")
# censusRace <- get_decennial(geography = "tract", variables = racevars, state = 39, 
#                             county = 061, geometry = TRUE) %>% st_transform(3735)
# censusRace <- censusRace %>% 
#   spread(key = variable, value = value) %>%
#   mutate(prop_white = round(white/total_pop,4),
#          prop_black = round(black/total_pop,4),
#          prop_asian = round(asian/total_pop,4),
#          prop_hispanic = round(hispanic/total_pop,4),
#          prop_two = round(two_or_more/total_pop,4)) %>%
#   gather("variable", "value", -GEOID, -NAME, -geometry) %>%
#   dplyr::select(GEOID, NAME, variable, value, geometry)
# st_write(censusRace, "censusRace.shp")

# Other place-related variables from the 2015 American Community Survey
# v15 <- load_variables(2015, "acs5", cache = TRUE)
# write_csv(v15,"acs_vars_2015.csv")
# acsvars <- c(total_pop = "B01003_001",
#                total_males = "B01001_002",
#                males_18_19 = "B01001_007",
#                males_20 = "B01001_008",
#                males_21 = "B01001_009",
#                males_22_24 = "B01001_010",
#                males_25_29 = "B01001_011",
#                males_30_34 = "B01001_012",
#                males_35_39 = "B01001_013",
#                males_40_44 = "B01001_014",
#                males_45_49 = "B01001_015",
#                males_50_54 = "B01001_016",
#                males_55_59 = "B01001_017",
#                males_60_61 = "B01001_018",
#                males_62_64 = "B01001_019",
#                males_65_66 = "B01001_020",
#                males_67_69 = "B01001_021",
#                males_70_74 = "B01001_022",
#                males_75_79 = "B01001_023",
#                males_80_84 = "B01001_024",
#                males_85plus = "B01001_025",
#                medincome = "B19013_001",
#                per_capita_income = "B19301_001",
#                total_blw_poverty_lvl = "B17020_002",
#                median_home_value = "B25077_001",
#                bachelors_or_higher = "B23006_023",
#                unemployed_over_16yrs = "B23025_007"
#                )
# acsData <- get_acs(geography = "tract",
#                    variables = acsvars,
#                    state = 39,
#                    county = 061,
#                    geometry = TRUE) %>% st_transform(3735)
# acsData <- acsData %>%
#   dplyr::select(-moe) %>%
#   spread(key = variable, value = estimate) %>%
#   mutate(log_pop = log(total_pop),
#          prop_males = round(total_males/total_pop,4),
#          prop_males_18to24 = round((males_18_19+males_20+males_21+males_22_24)/total_males,4),
#          prop_males_25to34 = round((males_25_29+males_30_34)/total_males,4),
#          prop_males_25to44 = round((males_25_29+males_30_34+males_35_39+males_40_44)/total_males,4),
#          prop_males_35to49 = round((males_35_39+males_40_44+males_45_49)/total_males,4),
#          prop_males_50to64 = round((males_50_54+males_55_59+males_60_61+males_62_64)/total_males,4),
#          prop_males_65up = round((males_65_66+males_67_69+males_70_74+males_75_79+males_85plus)/total_males,4),
#          prop_poverty = round(total_blw_poverty_lvl/total_pop,4),
#          prop_bach_or_higher = round(bachelors_or_higher/total_pop,4),
#          prop_unempl = round(unemployed_over_16yrs/total_pop,4)) %>%
#   gather("variable", "estimate", -GEOID, -NAME, -geometry) %>%
#   dplyr::select(GEOID, NAME, variable, estimate, geometry)
# acsDataTEMP <- acsData %>% filter(stringr::str_detect(variable, 'prop')) # checking to make sure my 'proportion' variables aren't out of whack
# min(acsDataTEMP$estimate) # should be between 0 and 1
# max(acsDataTEMP$estimate) # should be between 0 and 1
# st_write(acsData, "acsData.shp", update = T)

######################################################################################
#############################
# Load data from RDS files. #
#############################
######################################################################################

ems <- read_rds("ems.RDS") %>% as_tibble() # Emergency services calls
drugs_cops <- read_rds("drugs_cops.RDS") %>% as_tibble() # Drug-related police data
heroin_cops <- read_rds("heroin_cops.RDS") %>% as_tibble() # Heroin-related police data
crimes <- read_rds("crimes.RDS") %>% as_tibble() # Crimes reported in Cincinnati
c311 <- read_rds("c311.RDS") %>% as_tibble() # 311 calls
code <- read_rds("code.RDS") %>% as_tibble() # Code enforcement
cincinnati <- read_rds("cincinnati.RDS") %>% st_transform(3735)
sna <- read_rds("sna.RDS") %>% st_transform(3735) # Cincinnati SNA (Statistical Neighborhood Approximations) Boundaries
districts_cops <- read_rds("districts_cops.RDS") %>% st_transform(3735) # Police districts
firehouses <- read_rds("firehouses.RDS") %>% st_transform(3735) # Firehouses
sheriff <- read_rds("sheriff.RDS") %>% st_transform(3735) # Sheriff stations
censusRace <- st_read("censusRace.shp") # Race/ethnicity counts and %s by census tract
acsData <- st_read("acsData.shp") # Covariates from American Community Survey 
zoning <- read_rds("zoning.RDS") %>% st_transform(3735) # Zoning
transit <- read_rds("transit_stops.RDS") %>% st_transform(3735) # Union Terminal

######################################################################################
###############################
# Load data downloaded files. #
###############################
######################################################################################

# Naloxone access sites in Hamilton County (source: https://takechargeohio.org/map) 
# Note this was manually geocoded in ArcMap
nalox_sites <- read_csv("naloxone_distribution_sites.csv", col_names = T) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(3735) 

# Hamilton streets (source: https://catalog.data.gov/dataset/tiger-line-shapefile-2014-county-hamilton-county-oh-all-roads-county-based-shapefile)
hamilton_streets <- st_read("tl_2014_39061_roads.shp") %>%
  st_transform(3735) 

# Buildings ordered vacant by the city because unsafe/condemned/etc (source: City of Cincinnati http://cagismaps.hamilton-co.org/cincinnatiServices/CodeEnforcement/CincinnatiVacantBuildingCases/)
# Note this was manually geocoded in ArcMap
vacant_buildings <- st_read("vacantbldgs.shp") %>% st_transform(3735) 

# Ohio counties, state boundary, and Hamilton County only
ohio_counties <- st_read("tl_2016_39_cousub.shp") %>% st_transform(3735) # From:  https://catalog.data.gov/dataset/tiger-line-shapefile-2016-state-ohio-current-county-subdivision-state-based
ohio_boundary <- st_union(ohio_counties)

hamilton <- st_union(ohio_counties[which(ohio_counties$COUNTYFP == "061"),]) %>%
  st_transform(3735)

# Special business licenses 
# Source: https://data.cincinnati-oh.gov/Growing-Economic-Opportunities/Business-Licenses/7dk3-gngs
biz_licenses <- read_csv("Business_Licenses.csv", col_names = T) %>%
  filter(!is.na(LATITUDE)) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(3735)

# Weather measured from Cincinnati airport.
weather <- read_csv("weather.csv")
weather <- weather %>% dplyr::select(STATION, DATE, HourlyDryBulbTemperature, HourlyPrecipitation, SOURCE, REPORT_TYPE)

# Fast food chain locations
# Manually generated using sources of information about fast food chains present in OH (see data source list) and KML file built in Google Maps
ffood <- st_read("Fast food Cincinnati.kml") %>% st_set_crs(4326) %>%
  st_transform(3735)
ffood <- st_zm(ffood, drop = T, what = "ZM")

######################################################################################
#########################################
# Basic cleaning and data manipulation. #
#########################################
######################################################################################

# Outcome of interest: heroin overdose
# Heroin-related portions of ems dataset.  Note that this selects from disposition_text for narcan (naloxone) usage, used to combat fatal heroin overdoses, in addition to incident_type_ids from the data dictionaries. Nick also went through manually to confirm that the data dictionary doesn't miss any heroin-related incidents.
ems <- ems[which(!is.na(ems$latitude_x)), ] # TODO: see whether NAs are distributed spatially or across time.
ems$year <- str_sub(ems$create_time_incident, start = 1, end = 4)
ems15 <- ems[which(ems$year == "2015"),]
ems16 <- ems[which(ems$year == "2016"),]
ems17 <- ems[which(ems$year == "2017"),]
ems18 <- ems[which(ems$year == "2018"),]
ems19 <- ems[which(ems$year == "2019"),]

heroin_ems <- ems[which(
  str_detect(ems$disposition_text, "NAR") |
    str_detect(ems$disposition_text, "NART") |
    ems$incident_type_id == "HEROINF - FIRE ONLY" |
    ems$incident_type_id == "HEROIN-COMBINED" |
    ems$incident_type_id == "HEROINF-FIRE ONLY" |
    ems$incident_type_id == "HERONF" |
    ems$incident_type_id == "HEORIF"), ] %>% 
  st_as_sf(coords = c("longitude_x", "latitude_x"), crs = 4326, agr = "constant") %>%
  st_transform(3735)
weather$floor_date <- ymd_hms(weather$DATE, tz = "UTC") %>% floor_date(unit = "hour")
heroin_ems$floor_date <- floor_date(ymd_hms(heroin_ems$create_time_incident, tz = "EST"), unit = "hour") %>% with_tz(tz = "UTC")
heroin_ems <- left_join(heroin_ems, 
                        weather %>% 
                          dplyr::mutate(precipitation = HourlyPrecipitation,
                                        temperature = HourlyDryBulbTemperature) %>%
                          dplyr::select(floor_date, temperature, precipitation),
                        by = c("floor_date")
)
heroin_ems <- heroin_ems[cincinnati,]
heroin_ems15 <- heroin_ems[which(heroin_ems$year == "2015"),]
heroin_ems16 <- heroin_ems[which(heroin_ems$year == "2016"),]
heroin_ems17 <- heroin_ems[which(heroin_ems$year == "2017"),]
heroin_ems18 <- heroin_ems[which(heroin_ems$year == "2018"),]
heroin_ems19 <- heroin_ems[which(heroin_ems$year == "2019"),]

heroin_train <- rbind(heroin_ems15, heroin_ems16, heroin_ems17, heroin_ems18)
heroin_test <- heroin_ems19

# # drugs_cops
# drugs_cops <- drugs_cops[!is.na(drugs_cops$latitude_x), ] %>%
#   st_as_sf(coords = c("longitude_x", "latitude_x"), crs = 4326, agr = "constant") %>%
#   st_transform(3735)
# 
# # heroin_cops
# heroin_cops <- heroin_cops[!is.na(heroin_cops$latitude_x), ] %>%
#   st_as_sf(coords = c("longitude_x", "latitude_x"), crs = 4326, agr = "constant") %>%
#   st_transform(3735)

# crimes
crimes <- crimes[!is.na(crimes$latitude_x), ] %>%
  st_as_sf(coords = c("longitude_x", "latitude_x"), crs = 4326, agr = "constant") %>%
  st_transform(3735)

# c311
c311 <- c311[!is.na(c311$latitude), ] %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(3735)
graffiti <- c311 %>% filter(grepl("Graffiti", service_name) == TRUE) %>% 
  filter(requested_date >= as.Date("2015-01-01"))
blight_311 <- c311 %>% filter(grepl("Unsanitary", service_name) == TRUE |  
                                          grepl("Waste", service_name) == TRUE |
                                          grepl("waste", service_name) == TRUE | 
                                          grepl("Trash", service_name) == TRUE | 
                                          grepl("trash", service_name) == TRUE | 
                                          grepl("Dumping", service_name) == TRUE | 
                                          grepl("dumping", service_name) == TRUE | 
                                          grepl("Sewage", service_name) == TRUE | 
                                          grepl("sewage", service_name) == TRUE |
                                          grepl("Litter", service_name) == TRUE |
                                          grepl("litter", service_name) == TRUE |
                                          grepl("Mold", service_name) == TRUE | 
                                          grepl("Roaches", service_name) == TRUE | 
                                          grepl("Mice", service_name) == TRUE |
                                          grepl("Rats", service_name) == TRUE | 
                                          grepl("Rodents", service_name) == TRUE |
                                          grepl("Fleas", service_name) == TRUE | 
                                          grepl("Bed Bugs", service_name) == TRUE) %>%
  filter(requested_date >= as.Date("2015-01-01"))
pest_311 <- c311 %>% filter(grepl("Roaches", service_name) == TRUE | 
                              grepl("roaches", service_name) == TRUE | 
                              grepl("Mice", service_name) == TRUE |
                              grepl("mice", service_name) == TRUE |
                              grepl("Rats", service_name) == TRUE | 
                              grepl("rats", service_name) == TRUE | 
                              grepl("Rodents", service_name) == TRUE |
                              grepl("rodents", service_name) == TRUE |
                              grepl("Fleas", service_name) == TRUE | 
                              grepl("Bed Bugs", service_name) == TRUE) %>%
  filter(requested_date >= as.Date("2015-01-01"))

# Zoning violation codes
code <- code %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(3735)

abandoned_vehicles <- code %>% dplyr::filter(comp_type_desc == "Abandoned Vehicle Code Enforcement")
abandoned_vehicles <- abandoned_vehicles[cincinnati,]

complainedTrash <- code %>% filter(comp_type_desc == "Trash/Litter/Tall Grass Complaint")
complainedTrash <- complainedTrash[cincinnati,]

# Firearms and weapons dealers
firearms <- biz_licenses %>% filter(LICENSE == "DANGEROUS WEAPONS" | 
                                    LICENSE == "RETAIL DEALER IN FIREARMS AND AMMUNITION")
firearms <- firearms[cincinnati,]

# Cabaret, pool halls and other 'special business licenses'
funTimes <- biz_licenses %>% filter(LICENSE == "BILLIARDS AND POOL TABLE" | 
                                      LICENSE == "MASSAGE PRACTITIONER" |
                                      LICENSE == "GAME ARCADE" |
                                      LICENSE == "CABARET" |
                                      LICENSE == "DANCE HALL" |
                                      LICENSE == "SEXUALLY ORIENTED BUSINESS" |
                                      LICENSE == "MASSAGE ESTABLISHMENT")
funTimes <- funTimes[cincinnati,]

# Point location of Union Terminal, main train station in south Cincinnati

# lat <- c(-84.53228)
# long <- c(39.108841)
# unionTerminal <- as.data.frame(cbind(lat, long))
# unionTerminal <- unionTerminal %>% st_as_sf(coords = c("long", "lat"), crs = 4326, 
#                                             agr = "constant") %>%
#   st_transform(3735)
transit <- transit %>% filter(STOPNAME == "Museum Ctr Layover")
unionTerminal <- slice(transit, 1L)
rm(transit)

# Fast food
ffood <- ffood[cincinnati,]

# Assault crimes
crime_assault <- crimes %>% filter(grepl("ASSAULT", offense) == TRUE) %>%
  filter(date_reported >= as.Date("2015-01-01"))
crime_assault <- crime_assault[cincinnati,]

# Murder crimes
crime_murder <- crimes %>% filter(grepl("MURDER", offense) == TRUE | 
                                    grepl("HOMICIDE", offense) == TRUE) %>%
  filter(date_reported >= as.Date("2015-01-01"))
crime_murder <- crime_murder[cincinnati,]

# Weather
weather$floor_date <- ymd_hms(weather$DATE, tz = "UTC") %>% floor_date(unit = "hour")

# Land use
zoning <- zoning %>% mutate(zone_type =
  if_else(grepl("SF-", ZONE_TYPE) == TRUE, "Single_Family",
  if_else(grepl("RM", ZONE_TYPE) == TRUE, "Residential_MultiFamOrMixed",
  if_else(grepl("RF", ZONE_TYPE) == TRUE, "Riverfront",
  if_else(grepl("RM-0.7", ZONE_TYPE) == TRUE, "Residential_MultiFamOrMixed",
  if_else(grepl("OL", ZONE_TYPE) == TRUE, "Office",
  if_else(grepl("OG", ZONE_TYPE) == TRUE, "Office",
  if_else(grepl("C", ZONE_TYPE) == TRUE, "Commercial",
  if_else(grepl("ML", ZONE_TYPE) == TRUE, "Manufacturing",
  if_else(grepl("MA", ZONE_TYPE) == TRUE, "Manufacturing",
  if_else(grepl("MG", ZONE_TYPE) == TRUE, "Manufacturing",
  if_else(grepl("ME", ZONE_TYPE) == TRUE, "Manufacturing",
  if_else(grepl("PD", ZONE_TYPE) == TRUE, "Planned_Development",
  if_else(grepl("PR", ZONE_TYPE) == TRUE, "Park_Or_Recreational",
  if_else(grepl("UM", ZONE_TYPE) == TRUE, "Urban",
  if_else(grepl("DD", ZONE_TYPE) == TRUE, "Downtown_District",
  if_else(grepl("IR", ZONE_TYPE) == TRUE, "Institutional_Residential",
  if_else(grepl("T4", ZONE_TYPE) == TRUE, "Urban",
  if_else(grepl("T5", ZONE_TYPE) == TRUE, "Urban",
  if_else(grepl("T3", ZONE_TYPE) == TRUE, "Suburban",
  NA_character_))))))))))))))))))))

zoning <- zoning %>% mutate(zone_collapsed = 
                              if_else(zone_type == "Single_Family", "Residential", 
                                      if_else(zone_type == "Residential_MultiFamOrMixed", "Residential", 
                                              if_else(zone_type == "Residential_MultiFamOrMixed", "Residential", 
                                                      if_else(zone_type == "Institutional_Residential", "Residential",
                                                              if_else(zone_type == "Office", "Commercial", 
                                                                      if_else(zone_type == "Commercial", "Commercial", 
                                                                              if_else(zone_type == "Downtown_District", "Urban", 
                                                                                      if_else(zone_type == "Urban", "Urban", 
                                                                                              if_else(zone_type == "Manufacturing", "Manufacturing", 
                                                                                                      if_else(zone_type == "Park_Or_Recreational", "Park and Riverfront", 
                                                                                                              if_else(zone_type == "Riverfront", "Park and Riverfront", "Other"))))))))))))
zoning$zone_collapsed[is.na(zoning$zone_collapsed)] = "Other"

# ggplot() + geom_sf(data = cincinnati) + geom_sf(data = dplyr::select(zoning, zone_collapsed, geometry), (aes(fill = zone_collapsed)))

zoning <- zoning %>% mutate(potential_drug_use_sites = if_else(zone_collapsed == "Manufacturing", "Manufacturing, Urban, and Recreational Land Use",
                                                                 if_else(zone_collapsed == "Park and Riverfront", "Manufacturing, Urban, and Recreational Land Use",
                                                                         if_else(zone_collapsed == "Urban", "Manufacturing, Urban, and Recreational Land Use", "Other Land Use"))))

# ggplot() + geom_sf(data = cincinnati) + geom_sf(data = dplyr::select(zoning, potential_drug_use_sites, geometry), (aes(fill = potential_drug_use_sites)))

zones_likely_drug_sale <- zoning %>% filter(potential_drug_use_sites == "Manufacturing, Urban, and Recreational Land Use")
```

# Introduction

The Ohio Valley is a region of the midwest and midsouth United States in a public health crisis. Abuse of opioids, a class of drug that includes legal prescription painkillers like fentanyl and illegal painkiller derivatives like heroin, is widespread across Ohio, Pennsylvania, Kentucky and Indiana[^1],[^2],[^3]. These four states' epidemic of overdose deaths has driven a nationwide 29% increase in the mortality rate of Americans aged 29-34 since 2010[^4]. Ohio reports the second-highest rate of opioid-related drug overdose deaths in the country[^5], with fatalities most pronounced in the state's southwestern counties, where overdose death rates are two to four times the national average[^5],[^6]. Therefore, preventing and decreasing deaths due to overdose is an urgent policy priority in the region.

The following analysis focuses on southwest Ohio's largest city, Cincinnati, and heroin-related overdose events. Cincinnati declared heroin overdoses an "epidemic" in 2016 after 174 deaths occurred in a single week, overwhelming the County Medical Examiner's office and straining the capacity of first responders to administer Narcan (naloxone), an overdose reversal drug, at the scene of overdose events[^7]. In response, the city began leveraging EMS call data to map heroin and other opioid overdoses and strategically deploy medical personnel and distribute prevention resources to medical professionals[^8]. These data are currently viewable in a public dashboard [online](https://insights.cincinnati-oh.gov/stories/s/Heroin-Overdose-Responses/dm3s-ep3u/). 

```{r map_of_midwest}
# Map
states <- st_as_sf(map("state", plot = FALSE, fill = TRUE)) # state boundaries
world <- ne_countries(scale = "medium", returnclass = "sf") # countries/states
states <- cbind(states, st_coordinates(st_centroid(states))) # state names
states$ID <- toTitleCase(states$ID) # convert state names to proper nouns
ggplot() +
  geom_sf(data = states, fill = NA) + 
  geom_text(data = states, aes(X, Y, label = ID), size = 4) +
  geom_sf(data = cincinnati, aes(fill = BND_NAME), alpha=0.3, color="#25CB10") +
  scale_fill_manual(values = c("#25CB10")) +
  coord_sf(xlim = c(-92, -79), ylim = c(36.15, 43.5), expand = FALSE) +
  labs(title = "Cincinnati, OH", subtitle = "In the greater Ohio Valley region") +
  theme(legend.position = "none") +
  mapTheme()

ggplot() +
  geom_sf(data = hamilton, fill = NA, color = "gray") +
  geom_sf(data = hamilton_streets, color = "gray") +
  geom_sf(data = cincinnati, fill = "#25CB10", color = "gray", alpha = 0.3) +
  labs(title="Cincinnati, OH", subtitle = "In Hamilton County, southwest OH") +
  mapTheme()
```

However, non-medical personnel are also a valuable overdose prevention resource, but less strategic planning seems to have been focused on the peers, family members, roommates and retailers of drug users at risk for heroin overdose. If non-medical persons were equipped with the overdose reversal drug naloxone and knew how to responsibly administer it, many deaths might be prevented. In 2017, the Hamilton County Department of Public Health (the county in which Cincinnati is located) founded the Narcan Distribution Collaborative (NDC) with a goal of distributing take-home kits of naloxone to members of the public at no charge[^9],[^10]. 

The NDC quickly outstripped Emergency Medical Services (EMS) and pharmacies as the largest consumer and provider of naloxone in the region[^11]. The organization has distributed more than 20,000 doses of naloxone since 2017[^9], but non-medical personnel must seek out a distribution site and proactively acquire a kit[^12]. And a map of naloxone distribution sites versus sites of heroin overdose in Cincinnati at the height of the epidemic demonstrates that sitse are not necessarily strategically placed near overdose clusters.

```{r overdose_vs_naloxone}
# Heroin overdose vs. Naloxone distribution sites in Hamilton County:
ggplot() +
  geom_sf(data = hamilton, fill = NA, colour = "gray") +
  geom_sf(data = hamilton_streets, colour = "gray") +
  geom_sf(data = cincinnati, fill = NA) +
  geom_sf(data = heroin_ems17, aes(colour = "Heroin overdose"), show.legend = "point", size = 1, alpha = 0.3) +
  geom_sf(data = nalox_sites, aes(colour = "Naloxone distributor"), show.legend = "point", size = 3, alpha = 0.7) +
  scale_colour_manual(values = c("Heroin overdose" = "#25CB10",
    "Naloxone distributor" = "#FA7800"), name = "Site", guide = guide_legend(override.aes = list(linetype = "blank"), shape = 16)) +
  labs(title="Supply vs. demand: Location of city heroin overdoses\nvs. county naloxone distribution sites", subtitle = "City of Cincinnati, Hamilton County, OH", caption = "Note: Data on heroin overdoses are only available for the city of Cincinnati; overdose\nevents in greater Hamilton County are unknown and therefore omitted from the map.") +
  mapTheme()
```

We propose that overdose deaths could be further reduced if the NDC had hyperlocal data on geospatial heroin overdose risk and used it to select seasonal sites for naloxone distribution and training (libraries, fast food restaurants, parks and similar).

Two recent spatial analyses of Cincinnati's EMS data[^13],[^14] suggest that heroin misuse and overdose are hyperlocal phenomena correlated with residents' age, sex and socioeconomic status, as well as features of the built environment such as likely locations of drug sale (abandoned properties, abandoned cars, neighborhoods zoned for manufacturing or parks) or retail common to low-income or industrial neighborhoods (fast food restaurants, pool halls, adult entertainment venues), and also some crime types (assault and violent crime). The following analysis builds on this literature to address an immediate health policy need: predict seasonal heroin overdose hotspots in Cincinnati to help the NDC proactively stock naloxone kits and train kit users in high-risk locations. 

# Data

### Sources

Data for this analysis were gathered from the following sources. Information spans the years 2015 - 2019 unless otherwise noted.

  - **[Open Data Cincinnati](https://data.cincinnati-oh.gov/)**
      - Emergency Medical Services calls
      - 311 non-emergency service requests 
      - Crime
      - Vacant, abandoned and condemned buildings
      - Abandoned vehicles (via zoning code violations data)
      - Land use/zoning (residential, commercial, industrial)
      - Neighborhoods (modified to fit US 2010 census tracts)
      - Locations of fire stations, EMS, police stations, hospitals, pharmacies
      - Locations of firearms and weapons dealers
      - Locations of pool halls, dance halls, massage parlors & sundry "special business license" locations
  - **[Take Charge Ohio](https://takechargeohio.org/map)**
      - Naloxone distribution sites (pharmacies, hospitals and clinics) (2019)
  - **[United States Census](https://factfinder.census.gov/faces/nav/jsf/pages/index.xhtml)**
      - Racial/ethnic composition of census tracts (2010) 
  - **[United States American Community Survey](https://www.census.gov/programs-surveys/acs)**
      - Sample-based estimates of census-tract-level age, sex, education level, income, employment, poverty and home value data (2015)
  - **[Longitudinal Tract Database](https://s4.ad.brown.edu/projects/diversity/Researcher/Bridging.htm)**
      - Public-use dataset re-estimating census data from the year 2000 within 2010 tract boundaries to enable analysis of change by tract
  - **[USGS](https://catalog.data.gov/dataset/tiger-line-shapefile-2016-state-ohio-current-county-subdivision-state-based)**
      - Ohio state, county, city and street lines and boundaries (2019)
  - **[National Weather Service](https://www.weather.gov/)**
      - Temperature 
      - Precipitation 
  - **[Google Maps](www.google.com/maps), [QSR Magazine](https://www.qsrmagazine.com/content/32-biggest-fast-food-chains-america), [Wikipedia](https://en.wikipedia.org/wiki/List_of_fast_food_restaurant_chains), [Thrillist](https://www.thrillist.com/eat/nation/best-midwest-restaurant-chains-fast-food)**
      - Fast food chain restaurant locations (Li et al. (2019)[^13] found that fast food locations were a strong covariate in predicting opioid overdose in Ohio, but their data source proved unavailable, a list of restaurants was generated based on major chains in the United States, midwest and Ohio, and a KML file manually generated in Google Maps).

# Exploratory approach

Our exploration of Cincinnati data sought to identify factors that co-occur with the outcome of interest, heroin overdose events, measured by Cincinnati EMS calls either caused explicitly in response to heroin overdoses or that involved heroin and led to the administration of Narcan between 2015 - 2019.

### Space/time process of heroin overdose events

This analysis focuses on heroin overdoses specifically, rather than other opioid drugs. Literature from the Hamilton County Department of Public Health, Ohio Department of Health, National Institute on Drug Abuse, and Centers for Disease Control report that the number of heroin overdose deaths in Ohio increased sharply between 2010 and 2016, specifically reporting a statistically significant one-year increase in Ohio from 2016 to 2017[^15], and have been in decline since that time[^16]. (Drug overdose deaths caused by the synthetic opioid fentanyl have caused an increase in _all_ opioid-related overdose deaths during this same time period, but an analysis of fentanyl is outside the scope of this project)[^17]. 

Data from Cincinnati mirror this statewide trend. The following maps plot the count of heroin overdose events in Cincinnati from 2015, 2017 and 2019 based on EMS call data. 

<span style="font-size:1.2em">**Locations of heroin overdose events in Cincinnati**</span>
```{r exploratory, fig.width = 13}
her2015 <- ggplot() +
  geom_sf(data = cincinnati, fill = NA) +
  geom_sf(data = heroin_ems15, size = 1, color = "#25CB10") +
  labs(title="2015") +
  theme(legend.position = "none") +
  mapTheme()

her2017 <- ggplot() +
  geom_sf(data = cincinnati, fill = NA) +
  geom_sf(data = heroin_ems17, size = 1, color = "#25CB10") +
  labs(title="2017") +
  theme(legend.position = "none") +
  mapTheme()

her2019 <- ggplot() +
  geom_sf(data = cincinnati, fill = NA) +
  geom_sf(data = heroin_ems17, size = 1, color = "#25CB10") +
  labs(title="2019") +
  theme(legend.position = "none") +
  mapTheme()
# 
# her2019 <- ggplot() +
#   geom_sf(data = cincinnati, fill = NA) +
#   geom_sf(data = heroin_ems19, aes(colour = "Heroin overdose"), show.legend = "point", size = 1) +
#   scale_colour_manual(values = c("Heroin overdose" = "#25CB10"),
#     name = NULL, guide = guide_legend(override.aes = list(linetype = "blank"), shape = 16)) +
#   labs(title="2019") +
#   mapTheme()

grid.arrange(her2015, her2017, her2019, ncol = 3)
```

### Features associated with heroin overdose 

The literature on opioid use (e.g., INSERT FOOTNOTES HERE) indicates that several features of a city or neighborhood or street corner's built environment, socioeconomic profile, retail landscape, visible blight, and violent crime rates are associated with an increased risk of a heroin overdose event. Below is the spatial distribution of these risk factors in Cincinnati. First are maps of factors that exist as time-invariant points in space; followed  in Cincinnati specifically.

<span style="font-size:1.2em">**Risk Factors**</span>
```{r risk_small_multiples, fig.width=10}
# Make a grid with 1000x1000ft grid cells.
fishnet <- 
  st_make_grid(cincinnati, cellsize = 1000) %>%
  st_sf()

# Select grid cells in Cincinnati, assign ID numbers to them.
fishnet <- 
  fishnet[cincinnati,] %>%
  mutate(uniqueID = rownames(.)) %>%
  dplyr::select(uniqueID)

# ggplot() +
#   geom_sf(data=cincinnati) +
#   geom_sf(data = rbind(vacant_buildings %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Vacant, Condemned Bldgs"),
#                        abandoned_vehicles %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Abandoned Cars"),
#                        complainedTrash %>% dplyr::select() %>%
#                          st_transform((st_crs(fishnet))) %>%
#                          mutate(Legend = "Trash Complaints"),
#                        pest_311 %>% dplyr::select() %>%
#                          st_transform((st_crs(fishnet))) %>%
#                          mutate(Legend = "Pest Complaints"),
#                        crime_assault %>% dplyr::select() %>%
#                          st_transform((st_crs(fishnet))) %>%
#                          mutate(Legend = "Assault Crimes"),
#                        crime_murder %>% dplyr::select() %>%
#                          st_transform((st_crs(fishnet))) %>%
#                          mutate(Legend = "Murder/Homicide"),
#                        zones_likely_drug_sale %>% dplyr::select() %>%
#                          st_transform((st_crs(fishnet))) %>%
#                          mutate(Legend = "Manufacturing and Recreational Land Use"),
#                        funTimes %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Adult Entertainment"),
#                        firearms %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Firearms Vendors"),
#                        ffood %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Fast Food Restaurants")),
#           size = .1) +
#   facet_wrap(~Legend, ncol = 2) +
#   labs(title = "Risk Factors") +
#   mapTheme() + 
#     theme(strip.text = element_text(size = 5))

# Risk factor plots with grid.arrange
expl_vac <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=vacant_buildings %>% dplyr::select()) + labs(title = "Vacant, Condemned Bldgs") + mapTheme()

expl_av <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=abandoned_vehicles %>% dplyr::select()) + labs(title = "Abandoned Vehicles") + mapTheme()

expl_ct <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=complainedTrash %>% dplyr::select()) + labs(title = "Trash Complaints") + mapTheme()

expl_pc <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=pest_311 %>% dplyr::select()) + labs(title = "Pest Complaints") + mapTheme()

expl_a <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=crime_assault %>% dplyr::select()) + labs(title = "Assaults") + mapTheme()

expl_mh <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=crime_murder %>% dplyr::select()) + labs(title = "Murders/Homicides") + mapTheme()

expl_mrlu <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=zones_likely_drug_sale %>% dplyr::select()) + labs(title = "Manufacturing/Recreational Land Use Zones") + mapTheme()

expl_ae <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=funTimes %>% dplyr::select()) + labs(title = "Adult Entertainment") + mapTheme()

expl_fv <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=firearms %>% dplyr::select()) + labs(title = "Firearms Vendors") + mapTheme()

expl_ff <- ggplot() +
  geom_sf(data=cincinnati) +
  geom_sf(data=ffood %>% dplyr::select()) + labs(title = "Fast Food Restaurants") + mapTheme()

grid.arrange(expl_vac, expl_av, ncol = 2) 
grid.arrange(expl_ct, expl_pc, ncol = 2)
grid.arrange(expl_a, expl_mh, ncol = 2)
grid.arrange(expl_mrlu, expl_ae, ncol = 2)
grid.arrange(expl_fv, expl_ff, ncol=2)

```

The maps suggest that most but not all of these factors demonstrate spatial clustering similar to Cincinnati's heroin overdose sites and may therefore be useful in predicting overdose risk.

The features that do not appear to mimic the spatial process are those derived from 311 non-criminal complaints about trash; crimes classified as assault; and the locations of firearms dealers. Trash complaints and assaults are too prevalent to be of use, while firearms and weapons retail are too sparse.

Data from the U.S. Census and American Communities Survey were also explored as potential predictors of heroin overdose. The proportion of various demographic groups by census tract are displayed below.

<span style="font-size:1.2em">**Demographic and Socioeconomic Factors by Census Tract**</span>
```{r census_acs_exploratory, fig.width=10}
censusRace_props <- censusRace %>% dplyr::filter(variable == "prop_white" | 
                                                   variable == "prop_black")
censusRace_props <- censusRace_props[cincinnati,]

propWhite <- censusRace_props %>% 
  filter(variable == "prop_white") %>%
  ggplot(aes(fill = value)) +
  geom_sf(color = NA) +
  coord_sf(crs = 26915) + 
  scale_fill_viridis_c() + 
  labs(title = "Proportion White residents", fill = "Proportion") +
  mapTheme()
propBlack <- censusRace_props %>% 
  filter(variable == "prop_black") %>%
  ggplot(aes(fill = value)) +
  geom_sf(color = NA) +
  coord_sf(crs = 26915) + 
  scale_fill_viridis_c() + 
  labs(title = "Proportion Black residents", fill = "Proportion") +
  mapTheme()
  
acsData_props <- acsData %>% dplyr::filter(variable == "prop_poverty" |
                                             variable == "prop_bach_or_higher" | 
                                             variable == "prop_males_25to44")
acsData_props <- acsData_props[cincinnati, ]

propPov <- acsData_props %>% 
  filter(variable == "prop_poverty") %>%
  ggplot(aes(fill = estimate)) +
  geom_sf(color = NA) +
  coord_sf(crs = 26915) + 
  scale_fill_viridis_c() + 
  labs(title = "Proportion residents in poverty", fill = "Proportion") +
  mapTheme()
propBach <- acsData_props %>% 
  filter(variable == "prop_bach_or_higher") %>%
  ggplot(aes(fill = estimate)) +
  geom_sf(color = NA) +
  coord_sf(crs = 26915) + 
  scale_fill_viridis_c() + 
  labs(title = "Proportion college-educated", fill = "Proportion") +
  mapTheme()
propMales <- acsData_props %>% 
  filter(variable == "prop_males_25to44") %>%
  ggplot(aes(fill = estimate)) +
  geom_sf(color = NA) +
  coord_sf(crs = 26915) + 
  scale_fill_viridis_c() + 
  labs(title = "Proportion male residents age 25-44", fill = "Proportion") +
  mapTheme()

acsMedHome <- acsData %>% dplyr::filter(variable == "median_home_value")
acsMedHome <- acsMedHome[cincinnati, ]
medHome <- acsMedHome %>% ggplot(aes(fill = estimate)) +
  geom_sf(color = NA) +
  coord_sf(crs = 26915) + 
  scale_fill_viridis_c() + 
  labs(title = "Median home value", fill = "Home value") +
  mapTheme()

grid.arrange(propWhite, propBlack, ncol = 2) 
grid.arrange(propPov, propBach, ncol = 2)
grid.arrange(propMales, medHome, ncol = 2)
```

Heroin use in Ohio is most prevalent among White, non-Hispanic males aged 25-44[^16], and it does appear that the proportion of young- and middle-aged White men in Cincinnati tracts demonstrates a roughly similar distribution as overdose events, with some exceptions. Poverty and low rates of college education also appear to be correlated with overdose.

# Spatial/time process 

As can be seen, the temporal process is similar to a negative quadratic function (a parabola that opens downard), while the spatial process displays clustering, most heavily in an arc on the southern side of the city, straddling train tracks and a waterway in south-central Cincinnati. 

### Units of spatial analysis

To better understand spatial interrelationships between overdoses and related factors, we overlay a grid on the city (referred to as the "fishnet") with 1000-square-foot cells. Using grid cells as a unit of analysis allows us to aggregate factors at very local geographies. In some sense the size of the grid cell (1000 sq. ft) is arbitrary; we chose a size that was large enough to demonstrate meaningful variation from other cells, but small enough to capture phenomena that might be local to a subsection of a neighborhood. 

```{r spacetime, fig.width=10}
# Maps of Cincinnati and fishnet overlay
cincy <- ggplot() +
  geom_sf(data=cincinnati) +
  labs(title = "Cincinnati, OH", subtitle = "City boundary") +
  mapTheme()
cincy_net <- ggplot() +
  geom_sf(data=fishnet) +
  labs(title = "'Fishnet' of Cincinnati, OH", subtitle = "Grid cell overlay") +
  mapTheme()
grid.arrange(cincy, cincy_net, ncol=2)

```
```{r heroin_grid}
# Adds count data for number of heroin responses to the fishnet.
heroin_net <- 
  heroin_train %>% 
  dplyr::select() %>% 
  mutate(countHeroinResponses = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countHeroinResponses = ifelse(is.na(countHeroinResponses), 0, countHeroinResponses),
         uniqueID = rownames(.),
         cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))

# Map of grid cells colored by number of heroin responses.
ggplot() +
  geom_sf(data = heroin_net, aes(fill = countHeroinResponses)) +
  scale_fill_viridis() +
  labs(title = "Number of heroin overdose responses per fishnet cell, 2015-2018", fill = "Response\ncount") +
  mapTheme()
```

### Feature engineering

We take a few different approaches to engineering the features (i.e., factors) associated with overdose events by grid cell. We then test to see which engineering approach is superior for an overdose prediction model by observing correlations between the engineered feature and the outcome. 

#### Counting risk factor events by grid cell
First, we take a straightforward approach of counting the number of factor incidences per grid cell. Although aggregation by grid cell is intuitive to understand, it is a "rigid" approach and prone to bias because these summary values are influenced not only by the actual frequency of the phenomenon in question, but also by the previously-mentioned arbitrary scale of each cell[^18]. It is this arbitrariness, or modifiability, of the grid cell size that can be a source of bias in interpreting count data.

Note that aggregation only applies to data that are points in space (e.g., locations of vacant buildings, assaults, fast food restaurants) and not to data that are spread across larger scales (e.g., a tract of land that is zoned for manufacturing use). Also note that firearms dealers have been omitted as a factor because there are so few data (<30 locations).

<span style="font-size:1.2em">**Count of risk factors by grid cell**</span>
```{r counts, fig.width=10}
###############################################################################
## Aggregate risk factor count data into fishnet.
###############################################################################
# Combines all of the occurrences of risk factors into one rbinded file and merges them with the fishnet.
vars_net <- 
  rbind(vacant_buildings %>% dplyr::select() %>%
                         st_transform(st_crs(fishnet)) %>%
                         mutate(Legend = "Vacant, Condemned Bldgs"),
                       abandoned_vehicles %>% dplyr::select() %>%
                         st_transform(st_crs(fishnet)) %>%
                         mutate(Legend = "Abandoned Cars"),
                       pest_311 %>% dplyr::select() %>%
                         st_transform((st_crs(fishnet))) %>%
                         mutate(Legend = "Pest Complaints"),
                       crime_murder %>% dplyr::select() %>%
                         st_transform((st_crs(fishnet))) %>%
                         mutate(Legend = "Murder/Homicide"),
                       funTimes %>% dplyr::select() %>%
                         st_transform(st_crs(fishnet)) %>%
                         mutate(Legend = "Adult Entertainment"),
                       ffood %>% dplyr::select() %>%
                         st_transform(st_crs(fishnet)) %>%
                         mutate(Legend = "Fast Food Restaurants")) %>%
  st_join(., fishnet, join=st_within) %>%
  st_set_geometry(NULL) %>%
  group_by(uniqueID, Legend) %>%
  summarize(count = n()) %>%
  full_join(fishnet) %>%
  spread(Legend, count, fill=0) %>%
  st_sf() %>%
  dplyr::select(-`<NA>`) %>%
  na.omit()

# Converts the data from wide to long.
vars_net.long <- 
  vars_net %>%
  gather(Variable, value, -geometry, -uniqueID)

ab <- ggplot() +
  geom_sf(data = filter(vars_net.long, Variable == "Abandoned Cars"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Abandoned Cars", fill = "Count") +
  mapTheme()
ae <- ggplot() +
  geom_sf(data = filter(vars_net.long, Variable == "Adult Entertainment"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Adult Entertainment", fill = "Count") +
  mapTheme()
ff <- ggplot() +
  geom_sf(data = filter(vars_net.long, Variable == "Fast Food Restaurants"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Fast Food Restaurants", fill = "Count") +
  mapTheme()
mh <- ggplot() +
  geom_sf(data = filter(vars_net.long, Variable == "Murder/Homicide"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Murder/Homicide", fill = "Count") +
  mapTheme()
pc <- ggplot() +
  geom_sf(data = filter(vars_net.long, Variable == "Pest Complaints"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Pest Complaints", fill = "Count") +
  mapTheme()
vb <- ggplot() +
  geom_sf(data = filter(vars_net.long, Variable == "Vacant, Condemned Bldgs"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Vacant, Condemned Bldgs", fill = "Count") +
  mapTheme()

grid.arrange(ab, ae, ncol = 2)
grid.arrange(ff, mh, ncol = 2)
grid.arrange(pc, vb, ncol = 2)

# # Makes (but does not display) maps of each risk factor on the fishnet.
# vars <- unique(vars_net.long$Variable)
# mapList <- list()
# for(i in vars){
#   mapList[[i]] <- 
#     ggplot() +
#     geom_sf(data = filter(vars_net.long, Variable == i), aes(fill=value), colour=NA) +
#     scale_fill_viridis(name="") +
#     labs(title=i, fill = "Count") +
#     mapTheme()}
# 
# # Maps of risk factors by fishnet.  Takes a few minutes to generate.  May need to change number of columns to generate correctly.
# do.call(grid.arrange,c(mapList, ncol = 2))


```

Next we re-engineer each risk factor point feature as an average nearest-neighbor distance variable. That is, we calculate the average distance from the center of a grid cell to the three or four nearest points. This provides more flexibility than the aggregation approach and is potentially a bias-reduced estimate of risk exposure.

<span style="font-size:1.2em">**Nearest neighbor risk factors by grid cell**</span>
```{r nn, fig.width=10}
###############################################################################
## Create nearest-neighbor risk metrics.
###############################################################################

# Gets average distance to the 3 or 4 nearest neighboring abandoned vehicles from the center of each fishnet cell.
vars_net$abandoned_vehicles.nn =
  nn_function(st_coordinates(st_centroid(vars_net)), st_coordinates(abandoned_vehicles), 4)

vars_net$adult_entertainment.nn =
  nn_function(st_coordinates(st_centroid(vars_net)), st_coordinates(funTimes), 3)

vars_net$fast_food.nn =
  nn_function(st_coordinates(st_centroid(vars_net)), st_coordinates(ffood), 4)

vars_net$murder.nn =
  nn_function(st_coordinates(st_centroid(vars_net)), st_coordinates(crime_murder), 4)

vars_net$pest_complaints.nn =
  nn_function(st_coordinates(st_centroid(vars_net)), st_coordinates(pest_311), 4)

vars_net$vacant_buildings.nn =
  nn_function(st_coordinates(st_centroid(vars_net)), st_coordinates(vacant_buildings), 4)

# Converts data from wide to long.
vars_net.long.nn <- 
  vars_net %>%
  dplyr::select(ends_with(".nn")) %>%
  gather(Variable, value, -geometry, -uniqueID)

ab.nn <- ggplot() +
  geom_sf(data = filter(vars_net.long.nn, Variable == "abandoned_vehicles.nn"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Abandoned Cars.nn", fill = "Count") +
  mapTheme()
ae.nn <- ggplot() +
  geom_sf(data = filter(vars_net.long.nn, Variable == "adult_entertainment.nn"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Adult Entertainment.nn", fill = "Count") +
  mapTheme()
ff.nn <- ggplot() +
  geom_sf(data = filter(vars_net.long.nn, Variable == "fast_food.nn"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Fast Food Restaurants.nn", fill = "Count") +
  mapTheme()
mh.nn <- ggplot() +
  geom_sf(data = filter(vars_net.long.nn, Variable == "murder.nn"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Murder/Homicide.nn", fill = "Count") +
  mapTheme()
pc.nn <- ggplot() +
  geom_sf(data = filter(vars_net.long.nn, Variable == "pest_complaints.nn"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Pest Complaints.nn", fill = "Count") +
  mapTheme()
vb.nn <- ggplot() +
  geom_sf(data = filter(vars_net.long.nn, Variable == "vacant_buildings.nn"), aes(fill=value), colour=NA) +
  scale_fill_viridis(name="") +
  labs(title="Vacant, Condemned Bldgs.nn", fill = "Count") +
  mapTheme()

grid.arrange(ab.nn, ae.nn, ncol = 2)
grid.arrange(ff.nn, mh.nn, ncol = 2)
grid.arrange(pc.nn, vb.nn, ncol = 2)

# # Creates maps for each nearest neighbor risk factor.
# vars <- unique(vars_net.long.nn$Variable)
# mapList <- list()
# for(i in vars){
#   mapList[[i]] <- 
#     ggplot() +
#     geom_sf(data = filter(vars_net.long.nn, Variable == i), aes(fill=value), colour=NA) +
#     scale_fill_viridis(name="") +
#     labs(title=i) +
#     mapTheme()}
# 
# # Maps the nearest neighbor risk factors.
# do.call(grid.arrange,c(mapList, ncol =2, top = "Nearest neighbor risk factors by grid cell"))
```

Finally, polygon data (e.g., land use zones, neighborhoods) were explored, as well as the distance to a single point of interest, the Union Terminal train station in Cincinnati. 

The heroin overdoses on the south side of the city are heavily clustered but report a vertical blank white space in the center of the main cluster; these are railroad tracks, a small waterway and Interstate 75, which run north-south and terminate at the Ohio River that marks the southern boundary of Cincinnati. This transit hub is centered around Union Terminal, a train station and transit center, and each grid cell's Euclidean distance to Union Terminal was calculated as a risk factor for overdose. 

```{r nonpoint_data}
###############################################################################
##  Euclidean distance
###############################################################################
UTpoint <-
  unionTerminal %>%
  st_centroid()

vars_net$UTdistance =
  st_distance(st_centroid(vars_net),UTpoint) %>%
  as.numeric() 

ggplot() +
  geom_sf(data=vars_net, aes(fill=UTdistance)) +
  scale_fill_viridis() +
  labs(title="Euclidean distance to Union Terminal transit hub", subtitle = "Cincinnati, OH", fill = "Distance") +
  mapTheme() 

###############################################################################
##  Adding non-point data to the fishnet (tracts, zones etc)
###############################################################################

# Prep final fishnet for analysis.
final_net <-
  left_join(heroin_net, st_set_geometry(vars_net, NULL), by="uniqueID") 

final_net <-
  st_centroid(final_net) %>%
  st_join(., dplyr::select(acsData_props %>% dplyr::mutate(prop_poverty = estimate), prop_poverty)) %>%
  st_join(., dplyr::select(sna, neighborhood = SNA_NAME)) %>%
  st_join(., dplyr::select(zones_likely_drug_sale, land_use = potential_drug_use_sites)) %>%
  st_join(., dplyr::select(acsData_props %>% dplyr::mutate(prop_bach_or_higher = estimate), prop_bach_or_higher)) %>%
  st_join(., dplyr::select(acsData_props %>% dplyr::mutate(prop_males_25to44 = estimate), prop_males_25to44)) %>%
  st_join(., dplyr::select(censusRace_props %>% dplyr::mutate(prop_white = value), prop_white)) %>%
  #st_join(., dplyr::select(acsMedHome %>% dplyr::mutate(med_home_value = estimate), med_home_value)) %>%
  st_set_geometry(NULL) %>%
  left_join(dplyr::select(final_net, geometry, uniqueID)) %>%
  st_sf() %>%
  na.omit()

# Remove duplicated values from final_net.
final_net <- final_net[!duplicated(final_net),] 

# # Map of the data under fishnet cells (e.g. zoning type, neighborhood name)
# neigh <- final_net %>% gather(Variable, Value, -geometry) %>%
#   filter(Variable == neighborhood) %>%
#   ggplot() +
#   geom_sf(aes(fill = Value)) +
#   scale_fill_viridis(discrete = TRUE) +
#   labs(title = "Neighborhoods") +
#   mapTheme() + theme(legend.position = "none")
# 
# land <- final_net %>% gather(Variable, Value, -geometry) %>%
#   filter(Variable == land_use) %>%
#   ggplot() +
#   geom_sf(aes(fill = Value)) +
#   scale_fill_viridis(discrete = TRUE) +
#   labs(title = "Manufacturing & Recreational Land Use") +
#   mapTheme() + theme(legend.position = "none")
# 
# pov <- final_net %>% gather(Variable, Value, -geometry) %>%
#   filter(Variable == prop_poverty) %>%
#   ggplot() +
#   geom_sf(aes(fill = Value)) +
#   scale_fill_viridis(discrete = TRUE) +
#   labs(title = "Proportion of Residents in Poverty") +
#   mapTheme() + theme(legend.position = "none")
# 
# white <- final_net %>% gather(Variable, Value, -geometry) %>%
#   filter(Variable == prop_white) %>%
#   ggplot() +
#   geom_sf(aes(fill = Value)) +
#   scale_fill_viridis(discrete = TRUE) +
#   labs(title = "Proportion White Residents") +
#   mapTheme() + theme(legend.position = "none")
# 
# coll <- final_net %>% gather(Variable, Value, -geometry) %>%
#   filter(Variable == prop_bach_or_higher) %>%
#   ggplot() +
#   geom_sf(aes(fill = Value)) +
#   scale_fill_viridis(discrete = TRUE) +
#   labs(title = "Proportion of College-Educated Residents") +
#   mapTheme() + theme(legend.position = "none")
# 
# males <- final_net %>% gather(Variable, Value, -geometry) %>%
#   filter(Variable == prop_males_25to44) %>%
#   ggplot() +
#   geom_sf(aes(fill = Value)) +
#   scale_fill_viridis(discrete = TRUE) +
#   labs(title = "Proportion of Males Age 25-44") +
#   mapTheme() + theme(legend.position = "none")
# 
# medH <- final_net %>% gather(Variable, Value, -geometry) %>%
#   filter(Variable == med_home_value) %>%
#   ggplot() +
#   geom_sf(aes(fill = Value)) +
#   scale_fill_viridis(discrete = TRUE) +
#   labs(title = "Median Home Value") +
#   mapTheme() + theme(legend.position = "none")
  
```

The correlations between each feature (and different method of engineering the feature) and the outcome of heroin overdose is below. 

<span style="font-size:1.2em">**Heroin overdose count as a function of risk factors**</span>
```{r correlations}
# Grouping by four so that the correlation plots display nicer
vars1 <- c(1, 4:20)
correlation.long1 <-
  st_set_geometry(final_net, NULL) %>%
  dplyr::select(vars1) %>%
  gather(Variable, Value, -countHeroinResponses)

vars2 <- c(1, 4:20)
correlation.long2 <-
  st_set_geometry(final_net, NULL) %>%
  dplyr::select(vars2) %>%
  gather(Variable, Value, -countHeroinResponses)

correlation.cor1 <-
  correlation.long1 %>%
  group_by(Variable) %>%
  summarize(correlation = cor(Value, countHeroinResponses, use = "complete.obs"))
unique(correlation.long1$Variable)
ggplot(correlation.long1, aes(Value, countHeroinResponses)) +
  geom_point(size = 0.1) +
  geom_text(data = correlation.cor1, aes(label = paste("r =", round(correlation, 2))),
            x=-Inf, y=Inf, vjust = 1, hjust = -.1) +
  geom_smooth(method = "lm", se = FALSE, colour = "#a2d7d8") +
  facet_wrap(~Variable, ncol = 2, scales = "free") 

correlation.cor2 <-
  correlation.long %>%
  group_by(Variable) %>%
  summarize(correlation = cor(Value, countHeroinResponses, use = "complete.obs"))
unique(correlation.long2$Variable)
ggplot(correlation.long2, aes(Value, countHeroinResponses)) +
  geom_point(size = 0.1) +
  geom_text(data = correlation.cor2, aes(label = paste("r =", round(correlation, 2))),
            x=-Inf, y=Inf, vjust = 1, hjust = -.1) +
  geom_smooth(method = "lm", se = FALSE, colour = "#a2d7d8") +
  facet_wrap(~Variable, ncol = 2, scales = "free") 
```

# Modeling approach

Our modeling approach is a geospatial latent risk model that employs Poisson regression to predict areas of high risk for heroin overdose. The model is trained on a dataset that pools data from four years of EMS heroin overdose data (2015, 2016, 2017, 2018), and the model includes "year" fixed effect to account for temporal differences. The model is tested on data from the final year of EMS data (2019). 

### Clustering effects 

The Local Morans I is a statistic that will identify heroin overdose events that are significantly non-random (i.e., clustered) relative to adjacent grid cells on the map of Cincinnati. The goal is to identify hot spots in which we strongly reject a null hypothesis that the count of narcotics possession crimes at a given location is randomly distributed relative to proximal neighbors

```{r modeling}
###############################################################################
##  Moran's I
###############################################################################

final_net.nb <- poly2nb(final_net, queen=TRUE)
final_net.weights <- nb2listw(final_net.nb, style="W", zero.policy=TRUE)

final_net.localMorans <- 
  cbind(
    as.data.frame(localmoran(final_net$countHeroinResponses, final_net.weights)),
    as.data.frame(final_net, NULL)) %>% 
  st_sf() %>%
  dplyr::select(HeroinResponse_Count = countHeroinResponses, 
                Local_Morans_I = Ii, 
                P_Value = `Pr(z > 0)`) %>%
  mutate(Significant_Hotspots = ifelse(P_Value <= 0.05, 1, 0)) %>%
  gather(Variable, Value, -geometry)

vars <- unique(final_net.localMorans$Variable)
varList <- list()

for(i in vars){
  varList[[i]] <- 
    ggplot() +
    geom_sf(data = filter(final_net.localMorans, Variable == i), aes(fill = Value), colour=NA) +
    scale_fill_viridis(name="") +
    labs(title=i) +
    mapTheme()}

# This needs space to generate correctly - make sure to expand the Plots window when running.
do.call(grid.arrange,c(varList, ncol = 4, top = "Local Moran's I statistics, Heroin Responses"))

###############################################################################
##  Poisson regression
###############################################################################

# Plot of distribution of heroin response counts: looks like Poisson distribution.
ggplot(final_net, aes(countHeroinResponses)) +
  geom_histogram(binwidth = 1) +
  labs(title = "Distribution of heroin response by grid cell")

```

### Training, Testing, and Cross-validating

```{r training}

# TODO: Update with desired regression variables.
# TODO: Names must match the names in final_net.
column_names <- colnames(final_net)
reg.vars <- c("Abandoned Cars", "vacant_buildings.nn", "adult_entertainment.nn", "SNA_NAME", "zone_type")

crossValidate <- function(dataset, id, dependentVariable, indVariables) {
  
  allPredictions <- data.frame()
  cvID_list <- unique(dataset[[id]])
  
  for (i in cvID_list) {
    
    thisFold <- i
    cat("This hold out fold is", thisFold, "\n")
    
    fold.train <- filter(dataset, dataset[[id]] != thisFold) %>% as.data.frame() %>% 
      dplyr::select(id, geometry, indVariables, dependentVariable)
    fold.test  <- filter(dataset, dataset[[id]] == thisFold) %>% as.data.frame() %>% 
      dplyr::select(id, geometry, indVariables, dependentVariable)
    
    regression <-
      glm(countHeroinResponses ~ ., family = "poisson", 
          data = fold.train %>% 
            dplyr::select(-geometry, -id))
    
    thisPrediction <- 
      mutate(fold.test, Prediction = predict(regression, fold.test, type = "response"))
    
    allPredictions <-
      rbind(allPredictions, thisPrediction)
    
  }
  return(st_sf(allPredictions))
}

reg.cv <- crossValidate(
  dataset = final_net,
  id = "cvID",
  dependentVariable = "countHeroinResponses",
  indVariables = reg.vars) %>%
  dplyr::select(cvID = cvID, countHeroinResponses, Prediction, geometry)

reg.spatialCV <- crossValidate(
  dataset = final_net,
  id = "SNA_NAME",
  dependentVariable = "countHeroinResponses",
  indVariables = reg.vars) %>%
  dplyr::select(cvID = SNA_NAME, countHeroinResponses, Prediction, geometry)

reg.summary <- 
  rbind(
    mutate(reg.cv,           Error = Prediction - countHeroinResponses,
           Regression = "Random k-fold CV"),
    
    mutate(reg.spatialCV,    Error = Prediction - countHeroinResponses,
           Regression = "Spatial LOGO-CV")) %>%
  st_sf() 

grid.arrange(
  reg.summary %>%
    ggplot() +
    geom_sf(aes(fill = Prediction)) +
    facet_wrap(~Regression) +
    scale_fill_viridis() +
    labs(title = "Predicted heroin responses by Regression") +
    mapTheme() + theme(legend.position="bottom"),

  filter(reg.summary, Regression == "Random k-fold CV") %>%
    ggplot() +
    geom_sf(aes(fill = countHeroinResponses)) +
    scale_fill_viridis() +
    labs(title = "Observed heroin responses\n") +
    mapTheme() + theme(legend.position="bottom"),

  ncol = 2
  )

filter(reg.summary, Regression == "Spatial LOGO-CV") %>%
  ggplot() +
  geom_sf(aes(fill = Error)) +
  facet_wrap(~Regression) +
  scale_fill_viridis() +
  labs(title = "Heroin response errors by Regression") +
  mapTheme()

```

# Accuracy

```{r acc}

  # Kable/Table of MAE.
  st_set_geometry(reg.summary, NULL) %>%
  group_by(Regression) %>%
  summarize(MAE = round(mean(abs(Prediction - countHeroinResponses), na.rm = T),2),
            SD_MAE = round(sd(abs(Prediction - countHeroinResponses), na.rm = T),2)) %>%
  kable(caption = "MAE by regression") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(1, color = "black", background = "#FDE725FF") %>%
  row_spec(2, color = "black", background = "#FDE725FF")

  # Predicted and observed heroin responses by observed heroin responses decile
  st_set_geometry(reg.summary, NULL) %>%
    group_by(Regression) %>%
    mutate(heroinResponse_Decile = ntile(countHeroinResponses, 10)) %>%
    group_by(Regression, heroinResponse_Decile) %>%
    summarize(meanObserved = mean(countHeroinResponses, na.rm=T),
              meanPrediction = mean(Prediction, na.rm=T)) %>%
    gather(Variable, Value, -Regression, -heroinResponse_Decile) %>%
    ggplot(aes(heroinResponse_Decile, Value, shape = Variable)) +
    geom_point(size = 2) + geom_path(aes(group = heroinResponse_Decile), colour = "black") +
    scale_shape_manual(values = c(2, 17)) +
    facet_wrap(~Regression) + xlim(0,10) +
    labs(title = "Predicted and observed heroin responses by observed heroin responses decile")

```

# Generalizability

```{r gen}

# I did not adapt this code, as it requires loading in census tract data.
# The code that Ken uses here is about comparing how the model does in majority white and majority non-white neighborhoods in the burglary / risk prediction markdown.

```

# Robustness checks

```{r robch}

# Not exactly sure what robustness means since we already cross-validated, so I'll put the code here that compares our model to a simpler kernel density model.

# Just kidding - I just read the assignment again and it interprets robustness to be accuracy v. generalizability.  That kind of features like in the previous section about generalizabiity, so idk how we want to write this portion of the markdown out.  Regardless, the code here is still about the kernel density model.

final_reg <- 
    filter(reg.summary, Regression == "Spatial LOGO-CV") %>%
    mutate(uniqueID = rownames(.))
  
  heroin_ppp <- as.ppp(st_coordinates(heroin_train), W = st_bbox(final_net))
  heroin_KD.1000 <- spatstat::density.ppp(heroin_ppp, 1000)
  heroin_KD.1500 <- spatstat::density.ppp(heroin_ppp, 1500)
  heroin_KD.2000 <- spatstat::density.ppp(heroin_ppp, 2000)
  heroin_KD.df <- rbind(
    mutate(data.frame(rasterToPoints(mask(raster(heroin_KD.1000), as(sna, 'Spatial')))), Legend = "1000 Ft."),
    mutate(data.frame(rasterToPoints(mask(raster(heroin_KD.1500), as(sna, 'Spatial')))), Legend = "1500 Ft."),
    mutate(data.frame(rasterToPoints(mask(raster(heroin_KD.2000), as(sna, 'Spatial')))), Legend = "2000 Ft.")) 
  
  heroin_KD.df$Legend <- factor(heroin_KD.df$Legend, levels = c("1000 Ft.", "1500 Ft.", "2000 Ft."))
  
  ggplot(data=heroin_KD.df, aes(x=x, y=y)) +
    geom_raster(aes(fill=layer)) + 
    facet_wrap(~Legend) +
    coord_sf(crs=st_crs(final_net)) + 
    scale_fill_viridis() +
    mapTheme()
  
  heroin_ppp <- as.ppp(st_coordinates(heroin_train), W = st_bbox(final_net))
  heroin_KD <- spatstat::density.ppp(heroin_ppp, 1000)
  
  as.data.frame(heroin_KD) %>%
    st_as_sf(coords = c("x", "y"), crs = st_crs(final_net)) %>%
    aggregate(., final_net, mean) %>%
    ggplot() +
    geom_sf(aes(fill=value)) +
    geom_sf(data = sample_n(heroin_train, 1500), size = .5) +
    scale_fill_viridis() +
    mapTheme()
  
  # Compute kernel density
  heroin_ppp <- as.ppp(st_coordinates(heroin_train), W = st_bbox(final_net))
  heroin_KD <- spatstat::density.ppp(heroin_ppp, 1000)
  # Convert kernel density to grid cells taking the mean
  heroin_KDE_sf <- as.data.frame(heroin_KD) %>%
    st_as_sf(coords = c("x", "y"), crs = st_crs(final_net)) %>%
    aggregate(., final_net, mean) %>%
    #Mutate the Risk_Category field as defined below.
    mutate(label = "Kernel Density",
           Risk_Category = ntile(value, 100),
           Risk_Category = case_when(
             Risk_Category >= 90 ~ "90% to 100%",
             Risk_Category >= 70 & Risk_Category <= 89 ~ "70% to 89%",
             Risk_Category >= 50 & Risk_Category <= 69 ~ "50% to 69%",
             Risk_Category >= 30 & Risk_Category <= 49 ~ "30% to 49%",
             Risk_Category >= 1 & Risk_Category <= 29 ~ "1% to 29%")) %>%
    #Bind to a layer where test set crime counts are spatially joined to the fisnnet.
    bind_cols(
      aggregate(
        dplyr::select(heroin_train) %>% mutate(heroinCount = 1), ., length) %>%
        mutate(heroinCount = replace_na(heroinCount, 0))) %>%
    #Select the fields we need
    dplyr::select(label, Risk_Category, heroinCount)
  
  # Repeat for the risk predictions (our model, not kernel density)
  heroin_risk_sf <-
    filter(final_reg, Regression == "Spatial LOGO-CV") %>%
    mutate(label = "Risk Predictions",
           Risk_Category = ntile(Prediction, 100),
           Risk_Category = case_when(
             Risk_Category >= 90 ~ "90% to 100%",
             Risk_Category >= 70 & Risk_Category <= 89 ~ "70% to 89%",
             Risk_Category >= 50 & Risk_Category <= 69 ~ "50% to 69%",
             Risk_Category >= 30 & Risk_Category <= 49 ~ "30% to 49%",
             Risk_Category >= 1 & Risk_Category <= 29 ~ "1% to 29%")) %>%
    bind_cols(
      aggregate(
        dplyr::select(heroin_train) %>% mutate(heroinCount = 1), ., length) %>%
        mutate(heroinCount = replace_na(heroinCount, 0))) %>%
    dplyr::select(label,Risk_Category, heroinCount)
  
  # Geographical comparison
  rbind(heroin_KDE_sf, heroin_risk_sf) %>%
    gather(Variable, Value, -label, -Risk_Category, -geometry) %>%
    ggplot() +
    geom_sf(aes(fill = Risk_Category), colour = NA) +
    geom_sf(data = sample_n(heroin_train, 1500), size = .1, colour = "black") +
    facet_wrap(~label, ) +
    scale_fill_viridis(discrete = TRUE) +
    labs(title="Comparison of Kernel Density and Risk Predictions",
         subtitle="Relative to test set points (in black)") +
    mapTheme()

  # Bar plot comparison
  rbind(heroin_KDE_sf, heroin_risk_sf) %>%
    st_set_geometry(NULL) %>%
    gather(Variable, Value, -label, -Risk_Category) %>%
    group_by(label, Risk_Category) %>%
    summarize(countHeroinResponses = sum(Value)) %>%
    ungroup() %>%
    group_by(label) %>%
    mutate(Rate_of_test_set_crimes = countHeroinResponses / sum(countHeroinResponses)) %>%
    ggplot(aes(Risk_Category,Rate_of_test_set_crimes)) +
    geom_bar(aes(fill=label), position="dodge", stat="identity") +
    scale_fill_viridis(discrete = TRUE)

```

# Improving the distribution of prevention resources in Cincinnati, OH

```{r improvement}

```

# Next steps for model improvement

A better model would incorporate panel data representing temporal units and a longitudinal regression design that considers time as a predictor. 

# Conclusion

# References
[^1]: National Institute on Drug Abuse. (2019). Opioid summaries by state. Accessed from https://www.drugabuse.gov/drugs-abuse/opioids/opioid-summaries-by-state
[^2]: National Institute on Drug Abuse. (2019). Pennsylvania opiod summary. Accessed from https://www.drugabuse.gov/opioid-summaries-by-state/pennsylvania-opioid-summary
[^3]: National Institute on Drug Abuse. (2019). Indiana opiod summary. Accessed from https://www.drugabuse.gov/drugs-abuse/opioids/opioid-summaries-by-state/indiana-opioid-summary
[^4]: Woolf, S.H. & Shoomaker, H. (2019). Life expectancy and mortality rates in the United States, 1959 - 2017. Journal of the American Medical Association, 322(20). 
[^5]: National Institute on Drug Abuse. (2019). Ohio opiod summary. Accessed from https://www.drugabuse.gov/opioid-summaries-by-state/ohio-opioid-summary
[^6]: Ohio Department of Health. (2017). Ohio drug overdose data: general findings. Accessed from https://odh.ohio.gov/wps/wcm/connect/gov/5deb684e-4667-4836-862b-cb5eb59acbd3/2017_OhioDrugOverdoseReport.pdf?MOD=AJPERES&CONVERT_TO=url&CACHEID=ROOTWORKSPACE.Z18_M1HGGIK0N0JO00QO9DDDDM3000-5deb684e-4667-4836-862b-cb5eb59acbd3-moxPbu6
[^7]: Mettler, K. (29 August 2016). 'This is unprecedented:' 174 heroin overdoses in 6 days in Cincinnati. The Washington Post. 
[^8]: City of Cincinnati. (2019). Heroin overdose responses. https://insights.cincinnati-oh.gov/stories/s/Heroin-Overdose-Responses/dm3s-ep3u/
[^9]: Hamilton County Department of Public Health. https://www.hamiltoncountyhealth.org/announcements/deaconess/ 
[^10]: Hamilton County Department of Public Health. https://www.hamiltoncountyhealth.org/harm-reduction/narcan/
[^11]: Ingram, T. (2017). Narcan Distribution Collaborative: Expanding acess in Hamilton County, Ohio and the impacts. Accessed from https://www.naccho.org/uploads/downloadable-resources/49-51-Hamilton-County-Narcan-Distribution-Collaborative.pdf
[^12]: insert citation
[^13]: Li, Z.R., Xie, E., Crawford, F.W., Warren, J.L., McConnell, K., Copple, J.T., Johnson, T., & Gonsalves, G.S. (2019). Suspected heroin-related overdoses incidents in Cincinnati, Ohio: A spatiotemporal analysis. PLOS Medicine, 16(11), pp. 1-15.
[^14]: Bates, S., Leonenko, V., Rineer, J., & Bobashev, G. (2018). Using synthetic populations to understand geospatial patterns in opioid related overdose and predicted opioid misuse. Computational and Mathematical Organization Theory, 25, pp. 25-36.
[^15]: Centers for Disease Control. (2017). Drug overdose deaths. Accessed from https://www.cdc.gov/drugoverdose/data/statedeaths.html
[^16]: Ohio Department of Health. (2018). 2018 Ohio Drug Overdose Data: General FIndings. Accessed from https://odh.ohio.gov/wps/wcm/connect/gov/d9ee6d3b-bf62-4b4f-8978-d7cfcd11348f/2018_OhioDrugOverdoseReport.pdf?MOD=AJPERES&CONVERT_TO=url&CACHEID=ROOTWORKSPACE.Z18_M1HGGIK0N0JO00QO9DDDDM3000-d9ee6d3b-bf62-4b4f-8978-d7cfcd11348f-mXhFqNO; National Institute on Drug Abuse. (2019). Ohio Opioid Summary. Accessed from https://www.drugabuse.gov/opioid-summaries-by-state/ohio-opioid-summary
[17^]: National Institute on Drug Abuse. Ohio Opioid Summary. Accessed from https://www.drugabuse.gov/opioid-summaries-by-state/ohio-opioid-summary
[^18]: Steif, K. (2019). Geospatial risk modeling - the case of crime. [Personal communication].