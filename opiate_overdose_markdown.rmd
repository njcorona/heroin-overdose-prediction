---
title: "MUSA 507 Final Project: Predicting Heroin Overdose Events in Cincinnati, OH"
author: "Claire Allen-Platt and Nicolas Corona"
date: "December 20, 2019"
output:  
  html_document#:
    toc: TRUE
    toc_float: true
    theme: united
  
---
```{r setup, include = TRUE}
knitr::opts_chunk$set(echo = TRUE, results = TRUE, message = FALSE, 
                      warning = FALSE, fig.align="center", cache=FALSE)
```

```{r load, results="hide"}
######################################################################################
##############################################
# Load packages, palettes, functions, themes #
##############################################
######################################################################################

library(here)
library(tidyverse)
library(dplyr)
library(janitor)
library(maps)
library(tools)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(QuantPsyc)
library(RSocrata)
library(viridis)
library(caret)
library(spatstat)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(stringr)
library(lubridate)
census_api_key("f4a1e79b1b513acf5523856785193ebfdecdd406")

# Themes and palettes
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}
palette_5_blOr <-  c("#1170AA","#5FA2CE","#A3CCE9","#FC7D0B","#C85200")

# Functions
nn_function <- function(measureFrom,measureTo,k) {
  measureFrom_Matrix <-
    as.matrix(measureFrom)
  measureTo_Matrix <-
    as.matrix(measureTo)
  nn <-   
    get.knnx(measureTo, measureFrom, k)$nn.dist
  output <-
    as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>% 
    dplyr::select(-thisPoint) %>%
    pull()
  
  return(output)  
}

######################################################################################
##########################
# Load data from online. #
##########################
######################################################################################

# ems <- read.socrata("https://data.cincinnati-oh.gov/resource/vnsz-a3wp.csv") 
# saveRDS(ems, "ems.RDS")
#
# drugs_cops <- read.socrata("https://data.cincinnati-oh.gov/resource/3gx7-se9a.csv")
# saveRDS(drugs_cops, "drugs_cops.RDS")
#
# heroin_cops <- read.socrata("https://data.cincinnati-oh.gov/resource/7mtn-nnb5.csv")
# saveRDS(heroin_cops, "heroin_cops.RDS")
#
# cops <- read.socrata("https://data.cincinnati-oh.gov/resource/gexm-h6bt.csv")
# saveRDS(cops, "cops.RDS")
# 
# crimes <- read.socrata("https://data.cincinnati-oh.gov/resource/k59e-2pvf.csv")
# saveRDS(crimes, "crimes.RDS")
# 
# c311 <- read.socrata("https://data.cincinnati-oh.gov/resource/4cjh-bm8b.csv")
# saveRDS(c311, "c311.RDS")
# 
# code <- read.socrata("https://data.cincinnati-oh.gov/resource/cncm-znd6.csv")
# saveRDS(code, "code.RDS")
# 
# cincinnati <- st_read("https://opendata.arcgis.com/datasets/ed78f4754b044ac5815d0a9efe9bb336_1.geojson") # Cincinnati city boundary shapefile.
# saveRDS(cincinnati, "cincinnati.RDS")
# 
# sna <- st_read("https://opendata.arcgis.com/datasets/572561553c9e4d618d2d7939c5261d46_0.geojson")
# saveRDS(sna, "sna.RDS")
# 
# districts_cops <- st_read("https://opendata.arcgis.com/datasets/9bc1afaff72e4f44a6d19280c159c951_4.geojson")
# saveRDS(districts_cops, "districts_cops.RDS")
# 
# firehouses <- st_read("https://opendata.arcgis.com/datasets/a6f043d181f94e37a274975a3718b7af_16.geojson")
# saveRDS(firehouses, "firehouses.RDS")
# 
# sheriff <- st_read("https://opendata.arcgis.com/datasets/ad2bd178b8624b04ae1878fe598c6001_3.geojson")
# saveRDS(sheriff, "sheriff.RDS")
# 
# zoning <- st_read("https://opendata.arcgis.com/datasets/b43c6f6671d54da298fd6110a3088557_11.geojson")
# saveRDS(zoning, "zoning.RDS")
# 
# # Census data
# # Race from the 2010 US Census
# racevars <- c(total_pop = "P003001",
#               white = "P003002", 
#               black = "P003003", 
#               asian = "P003005", 
#               hispanic = "P004003",
#               two_or_more = "P003008")
# censusRace <- get_decennial(geography = "tract", variables = racevars, state = 39, 
#                             county = 061, geometry = TRUE) %>% st_transform(3735)
# censusRace <- censusRace %>% 
#   spread(key = variable, value = value) %>%
#   mutate(prop_white = round(white/total_pop,4),
#          prop_black = round(black/total_pop,4),
#          prop_asian = round(asian/total_pop,4),
#          prop_hispanic = round(hispanic/total_pop,4),
#          prop_two = round(two_or_more/total_pop,4)) %>%
#   gather("variable", "value", -GEOID, -NAME, -geometry) %>%
#   dplyr::select(GEOID, NAME, variable, value, geometry)
# st_write(censusRace, "censusRace.shp")

# Other place-related variables from the 2015 American Community Survey
# v15 <- load_variables(2015, "acs5", cache = TRUE)
# write_csv(v15,"acs_vars_2015.csv")
# acsvars <- c(total_pop = "B01003_001",
#                total_males = "B01001_002",
#                males_18_19 = "B01001_007",
#                males_20 = "B01001_008",
#                males_21 = "B01001_009",
#                males_22_24 = "B01001_010",
#                males_25_29 = "B01001_011",
#                males_30_34 = "B01001_012",
#                males_35_39 = "B01001_013",
#                males_40_44 = "B01001_014",
#                males_45_49 = "B01001_015",
#                males_50_54 = "B01001_016",
#                males_55_59 = "B01001_017",
#                males_60_61 = "B01001_018",
#                males_62_64 = "B01001_019",
#                males_65_66 = "B01001_020",
#                males_67_69 = "B01001_021",
#                males_70_74 = "B01001_022",
#                males_75_79 = "B01001_023",
#                males_80_84 = "B01001_024",
#                males_85plus = "B01001_025",
#                medincome = "B19013_001",
#                per_capita_income = "B19301_001",
#                total_blw_poverty_lvl = "B17020_002",
#                median_home_value = "B25077_001",
#                bachelors_or_higher = "B23006_023",
#                unemployed_over_16yrs = "B23025_007"
#                )
# acsData <- get_acs(geography = "tract",
#                    variables = acsvars,
#                    state = 39,
#                    county = 061,
#                    geometry = TRUE) %>% st_transform(3735)
# acsData <- acsData %>%
#   dplyr::select(-moe) %>%
#   spread(key = variable, value = estimate) %>%
#   mutate(log_pop = log(total_pop),
#          prop_males = round(total_males/total_pop,4),
#          prop_males_18to24 = round((males_18_19+males_20+males_21+males_22_24)/total_males,4),
#          prop_males_25to34 = round((males_25_29+males_30_34)/total_males,4),
#          prop_males_35to49 = round((males_35_39+males_40_44+males_45_49)/total_males,4),
#          prop_males_50to64 = round((males_50_54+males_55_59+males_60_61+males_62_64)/total_males,4),
#          prop_males_65up = round((males_65_66+males_67_69+males_70_74+males_75_79+males_85plus)/total_males,4),
#          prop_poverty = round(total_blw_poverty_lvl/total_pop,4),
#          prop_bach_or_higher = round(bachelors_or_higher/total_pop,4),
#          prop_unempl = round(unemployed_over_16yrs/total_pop,4)) %>%
#   gather("variable", "estimate", -GEOID, -NAME, -geometry) %>%
#   dplyr::select(GEOID, NAME, variable, estimate, geometry)
# acsDataTEMP <- acsData %>% filter(stringr::str_detect(variable, 'prop')) # checking to make sure my 'proportion' variables aren't out of whack
# min(acsDataTEMP$estimate) # should be between 0 and 1
# max(acsDataTEMP$estimate) # should be between 0 and 1
# st_write(acsData, "acsData.shp", update = T)

######################################################################################
#############################
# Load data from RDS files. #
#############################
######################################################################################

ems <- read_rds("ems.RDS") %>% as_tibble() # Emergency services calls
drugs_cops <- read_rds("drugs_cops.RDS") %>% as_tibble() # Drug-related police data
heroin_cops <- read_rds("heroin_cops.RDS") %>% as_tibble() # Heroin-related police data
crimes <- read_rds("crimes.RDS") %>% as_tibble() # Crimes reported in Cincinnati
c311 <- read_rds("c311.RDS") %>% as_tibble() # 311 calls
code <- read_rds("code.RDS") %>% as_tibble() # Code enforcement
cincinnati <- read_rds("cincinnati.RDS") %>% st_transform(3735)
sna <- read_rds("sna.RDS") %>% st_transform(3735) # Cincinnati SNA (Statistical Neighborhood Approximations) Boundaries
districts_cops <- read_rds("districts_cops.RDS") %>% st_transform(3735) # Police districts
firehouses <- read_rds("firehouses.RDS") %>% st_transform(3735) # Firehouses
sheriff <- read_rds("sheriff.RDS") %>% st_transform(3735) # Sheriff stations
censusRace <- st_read("censusRace.shp") # Race/ethnicity counts and %s by census tract
acsData <- st_read("acsData.shp") # Covariates from American Community Survey 
zoning <- read_rds("zoning.RDS") %>% st_transform(3735)

######################################################################################
###############################
# Load data downloaded files. #
###############################
######################################################################################

# Naloxone access sites in Hamilton County (source: https://takechargeohio.org/map) 
# Note this was manually geocoded in ArcMap
nalox_sites <- read_csv("naloxone_distribution_sites.csv", col_names = T) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(3735) 

# Hamilton streets (source: https://catalog.data.gov/dataset/tiger-line-shapefile-2014-county-hamilton-county-oh-all-roads-county-based-shapefile)
hamilton_streets <- st_read("tl_2014_39061_roads.shp") %>%
  st_transform(3735) 

# Buildings ordered vacant by the city because unsafe/condemned/etc (source: City of Cincinnati http://cagismaps.hamilton-co.org/cincinnatiServices/CodeEnforcement/CincinnatiVacantBuildingCases/)
# Note this was manually geocoded in ArcMap
vacant_buildings <- st_read("vacantbldgs.shp") %>% st_transform(3735) 

# Ohio counties, state boundary, and Hamilton County only
ohio_counties <- st_read("tl_2016_39_cousub.shp") %>% st_transform(3735) # From:  https://catalog.data.gov/dataset/tiger-line-shapefile-2016-state-ohio-current-county-subdivision-state-based
ohio_boundary <- st_union(ohio_counties)

hamilton <- st_union(ohio_counties[which(ohio_counties$COUNTYFP == "061"),]) %>%
  st_transform(3735)

# Special business licenses 
# Source: https://data.cincinnati-oh.gov/Growing-Economic-Opportunities/Business-Licenses/7dk3-gngs
biz_licenses <- read_csv("Business_Licenses.csv", col_names = T) %>%
  filter(!is.na(LATITUDE)) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(3735)

# Weather measured from Cincinnati airport.
weather <- read_csv("weather.csv")
weather <- weather %>% dplyr::select(STATION, DATE, HourlyDryBulbTemperature, HourlyPrecipitation, SOURCE, REPORT_TYPE)

# Fast food chain locations
# Manually generated using sources of information about fast food chains present in OH (see data source list) and KML file built in Google Maps
ffood <- st_read("Fast food Cincinnati.kml") %>% st_set_crs(4326) %>%
  st_transform(3735)

######################################################################################
#########################################
# Basic cleaning and data manipulation. #
#########################################
######################################################################################

# drugs_cops
drugs_cops <- drugs_cops[!is.na(drugs_cops$latitude_x), ] %>%
  st_as_sf(coords = c("longitude_x", "latitude_x"), crs = 4326, agr = "constant") %>%
  st_transform(3735)

# heroin_cops
heroin_cops <- heroin_cops[!is.na(heroin_cops$latitude_x), ] %>%
  st_as_sf(coords = c("longitude_x", "latitude_x"), crs = 4326, agr = "constant") %>%
  st_transform(3735)

# crimes
crimes <- crimes[!is.na(crimes$latitude_x), ] %>%
  st_as_sf(coords = c("longitude_x", "latitude_x"), crs = 4326, agr = "constant") %>%
  st_transform(3735)

# c311
c311 <- c311[!is.na(c311$latitude), ] %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(3735)
graffiti <- c311 %>% filter(grepl("Graffiti", service_name) == TRUE) %>% 
  filter(requested_date >= as.Date("2015-01-01"))
blight_311 <- c311 %>% filter(grepl("Unsanitary", service_name) == TRUE |  
                                          grepl("Waste", service_name) == TRUE |
                                          grepl("waste", service_name) == TRUE | 
                                          grepl("Trash", service_name) == TRUE | 
                                          grepl("trash", service_name) == TRUE | 
                                          grepl("Dumping", service_name) == TRUE | 
                                          grepl("dumping", service_name) == TRUE | 
                                          grepl("Sewage", service_name) == TRUE | 
                                          grepl("sewage", service_name) == TRUE |
                                          grepl("Litter", service_name) == TRUE |
                                          grepl("litter", service_name) == TRUE |
                                          grepl("Mold", service_name) == TRUE | 
                                          grepl("Roaches", service_name) == TRUE | 
                                          grepl("Mice", service_name) == TRUE |
                                          grepl("Rats", service_name) == TRUE | 
                                          grepl("Rodents", service_name) == TRUE |
                                          grepl("Fleas", service_name) == TRUE | 
                                          grepl("Bed Bugs", service_name) == TRUE) %>%
  filter(requested_date >= as.Date("2015-01-01"))

# code
code <- code %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(3735)

abandoned_vehicles <- code %>% dplyr::filter(comp_type_desc == "Abandoned Vehicle Code Enforcement")
complainedTrash <- code %>% filter(comp_type_desc == "Trash/Litter/Tall Grass Complaint")

# Firearms and weapons dealers
firearms <- biz_licenses %>% filter(LICENSE == "DANGEROUS WEAPONS" | 
                                    LICENSE == "RETAIL DEALER IN FIREARMS AND AMMUNITION")
# unique(firearms$LICENSE)

# Cabaret, pool halls and other 'special business licenses'
funTimes <- biz_licenses %>% filter(LICENSE == "BILLIARDS AND POOL TABLE" | 
                                      LICENSE == "MASSAGE PRACTITIONER" |
                                      LICENSE == "GAME ARCADE" |
                                      LICENSE == "CABARET" |
                                      LICENSE == "DANCE HALL" |
                                      LICENSE == "SEXUALLY ORIENTED BUSINESS" |
                                      LICENSE == "MASSAGE ESTABLISHMENT")

# Point location of Union Terminal, main train station in south Cincinnati
lat <- c(-84.53228)
long <- c(39.108841)
unionTerminal <- as.data.frame(cbind(lat, long))
unionTerminal <- unionTerminal %>% st_as_sf(coords = c("long", "lat"), crs = 4326, 
                                            agr = "constant") %>%
  st_transform(3735)

# Crime 
# Assault
crime_assault <- crimes %>% filter(grepl("ASSAULT", offense) == TRUE)
# Murder
crime_murder <- crimes %>% filter(grepl("MURDER", offense) == TRUE | 
                                    grepl("HOMICIDE", offense) == TRUE)
```

# Introduction

The Ohio Valley is a region of the midwest and midsouth United States in a public health crisis. Abuse of opioids, a class of drug that includes prescription painkillers, the illicit drug heroin, and the deadly opioid fentanyl, is widespread across Ohio, Pennsylvania, Kentucky and Indiana[^1],[^2],[^3]. These four states' epidemic of overdose deaths has driven a nationwide 29% increase in the mortality rate of Americans aged 29-34 since 2010[^4]. Ohio reports the second-highest rate of opioid-related drug overdose deaths in the country[^5], with fatalities most pronounced in the state's southwestern counties, where overdose death rates are two to four times the national average[^5],[^6]. Therefore, preventing and decreasing deaths due to overdose is an urgent policy priority in the region.

The following analysis focuses on southwest Ohio's largest city, Cincinnati, and heroin-related overdose events. Cincinnati declared heroin overdoses an "epidemic" in 2016 after 174 deaths occurred in a single week, overwhelming the County Medical Examiner's office and straining the capacity of first responders to administer Narcan (naloxone), an overdose reversal drug, at the scene of overdose events[^7]. In response, the city began leveraging EMS call data to map heroin and other opioid overdoses and strategically deploy medical personnel and distribute prevention resources to medical professionals[^8]. These data are currently viewable in a public dashboard [online](https://insights.cincinnati-oh.gov/stories/s/Heroin-Overdose-Responses/dm3s-ep3u/). 

```{r map_of_midwest}
# Map
states <- st_as_sf(map("state", plot = FALSE, fill = TRUE)) # state boundaries
world <- ne_countries(scale = "medium", returnclass = "sf") # countries/states
states <- cbind(states, st_coordinates(st_centroid(states))) # state names
states$ID <- toTitleCase(states$ID) # convert state names to proper nouns
ggplot() +
  geom_sf(data = states, fill = NA) + 
  geom_text(data = states, aes(X, Y, label = ID), size = 4) +
  geom_sf(data = cincinnati, aes(fill = BND_NAME), alpha=0.3, color="#25CB10") +
  scale_fill_manual(values = c("#25CB10")) +
  coord_sf(xlim = c(-92, -79), ylim = c(36.15, 43.5), expand = FALSE) +
  labs(title = "Cincinnati, OH", subtitle = "In the Midwest context") +
  theme(legend.position = "none") +
  mapTheme()
```

However, non-medical personnel are also a valuable overdose prevention resource, but less strategic planning seems to have been focused on the peers, family members, roommates and retailers of drug users at risk for heroin overdose. If non-medical persons were equipped with the overdose reversal drug naloxone and knew how to responsibly administer it, many deaths might be prevented. In 2017, the Hamilton County Department of Public Health (the county in which Cincinnati is located) founded the Narcan Distribution Collaborative (NDC) with a goal of distributing take-home kits of naloxone to members of the public at no charge[^9],[^10]. 

The NDC quickly outstripped Emergency Medical Services (EMS) and pharmacies as the largest consumer and provider of naloxone in the region[^11]. The organization has distributed more than 20,000 doses of naloxone since 2017[^9], but non-medical personnel must seek out a distribution site and proactively acquire a kit [^12]. And naloxone distribution sites are not strategically placed near overdose clusters.

```{r overdose_vs_naloxone}
# Heroin overdose vs. Naloxone distribution sites in Hamilton County:
ggplot() +
  geom_sf(data = hamilton, fill = NA, color = "gray") +
  geom_sf(data = hamilton_streets, color = "gray") +
  geom_sf(data = cincinnati, fill = NA) +
  geom_sf(data = heroin_ems17, size = 1, color = "#25CB10") +
  geom_sf(data = nalox_sites, size = 3, color = "#FA7800") +
  scale_color_manual(labels = c("Heroin overdose", "Naloxone distribution site")) +
  labs(title="Supply vs. Demand:\nLocation of Heroin Overdoses vs. Naloxone Distribution Sites",
       subtitle = "City of Cincinnati, Hamilton County, OH") +
  mapTheme()
```

We propose that overdose deaths could be further reduced if the NDC had hyperlocal data on geospatial heroin overdose risk and used it to select seasonal sites for naloxone distribution and training (libraries, fast food restaurants, parks and similar).

Two recent spatial analyses of Cincinnati's EMS data[^13],[^14] suggest that heroin misuse and overdose are hyperlocal phenomena correlated with residents' age, sex and socioeconomic status, as well as features of the built environment such as likely locations of drug sale (abandoned properties, abandoned cars, neighborhoods zoned for manufacturing) or retail common to low-income neighborhoods (fast food restaurants, [insert example]), and some crime types [insert examples]. The following analysis builds on this literature to address an immediate health policy need: predict seasonal heroin overdose hotspots in Cincinnati to help the NDC proactively stock naloxone kits and train kit users in high-risk locations. 

# Data

### Sources

Data for this analysis were gathered from the following sources. Information spans the years 2015 - 2019 unless otherwise noted.

  - **[Open Data Cincinnati](https://data.cincinnati-oh.gov/)**
      - Emergency Medical Services calls
      - 311 non-emergency service requests 
      - Crime
      - Vacant, abandoned and condemned buildings
      - Abandoned vehicles (via zoning code violations data)
      - Land use/zoning
      - Neighborhoods (modified to fit US 2010 census tracts)
      - Locations of fire stations, EMS, police stations, hospitals, pharmacies
      - Locations of firearms and weapons dealers
      - Locations of pool halls, dance halls, massage parlors & sundry "special business license" locations
      - Female-owned small businesses
  - **[Take Charge Ohio](https://takechargeohio.org/map)**
      - Naloxone distribution sites (pharmacies, hospitals and clinics) (2019)
  - **[United States Census](https://factfinder.census.gov/faces/nav/jsf/pages/index.xhtml)**
      - Racial/ethnic composition of census tracts (2010) 
  - **[United States American Community Survey](https://www.census.gov/programs-surveys/acs)**
      - Sample-based estimates of census-tract-level age, sex, education level, income, employment, poverty and home value data (2015)
  - **[Longitudinal Tract Database](https://s4.ad.brown.edu/projects/diversity/Researcher/Bridging.htm)**
      - Public-use dataset re-estimating census data from the year 2000 within 2010 tract boundaries to enable analysis of change by tract
  - **[USGS](https://catalog.data.gov/dataset/tiger-line-shapefile-2016-state-ohio-current-county-subdivision-state-based)**
      - Ohio state, county, city and street lines and boundaries (2019)
  - **[National Weather Service](https://www.weather.gov/)**
      - Temperature 
      - Precipitation 
  - **[Google Maps](www.google.com/maps), [QSR Magazine](https://www.qsrmagazine.com/content/32-biggest-fast-food-chains-america), [Wikipedia](https://en.wikipedia.org/wiki/List_of_fast_food_restaurant_chains), [Thrillist](https://www.thrillist.com/eat/nation/best-midwest-restaurant-chains-fast-food)**
      - Fast food chain restaurant locations (Li et al. (2019)[^13] found that fast food locations were a strong covariate in predicting opioid overdose in Ohio, but their data source proved unavailable, a list of restaurants was generated based on major chains in the United States, midwest and Ohio, and a KML file manually generated in Google Maps).

# Exploratory approach

Our exploration of Cincinnati data sought to identify factors that co-occur with overdose events. We sought to find correlates with our outcome of interest, that is, EMS calls either caused explicitly in response to heroin overdoses or that led to the administration of Narcan in Cincinnati.

### Space/time process of heroin overdose events

This analysis focuses on heroin overdoses specifically. Literature from the Hamilton County Department of Public Health, Ohio Department of Health, National Institute on Drug Abuse and Centers for Disease Control report that the number of heroin overdose deaths in Ohio increased sharply between 2010 and 2016, specifically reporting a statistically significant one-year increase in Ohio from 2016 to 2017[^15], and have been in decline since that time[^16]. (Drug overdose deaths caused by the synthetic opioid Fentanyl have caused an increase in _all_ opioid overdose deaths during this same time period, but an analysis of Fentanyl is outside the scope of this project)[^17]. 

Data from Cincinnati mirror this statewide trend. The following maps display the count of heroin overdose events in Cincinnati from 2015, 2017 and 2019, as measured by EMS calls either caused explicitly in response to heroin overdoses or that led to the administration of naloxone (also called Narcan, an overdose-reversal drug). 

```{r exploratory}
# Outcome of interest: heroin overdose 
ems <- ems[which(!is.na(ems$latitude_x)), ] # TODO: see whether NAs are distributed spatially or across time.
ems$year <- str_sub(ems$create_time_incident, start = 1, end = 4)
ems15 <- ems[which(ems$year == "2015"),]
ems16 <- ems[which(ems$year == "2016"),]
ems17 <- ems[which(ems$year == "2017"),]
ems18 <- ems[which(ems$year == "2018"),]
ems19 <- ems[which(ems$year == "2019"),]

# These years only have 1-17 records per year.
crimes <- crimes[which(str_sub(crimes$date_reported, start = 1, end = 4) != 1991 &
                         str_sub(crimes$date_reported, start = 1, end = 4) != 2003 &
                         str_sub(crimes$date_reported, start = 1, end = 4) != 2007 &
                         str_sub(crimes$date_reported, start = 1, end = 4) != 2008 &
                         str_sub(crimes$date_reported, start = 1, end = 4) != 2009
),]

# These years only have 74-310 records per year.
code <- code[which(str_sub(code$entered_date, start = 1, end = 4) != 1999 &
                     str_sub(code$entered_date, start = 1, end = 4) != 2000
),]

# Heroin-related portions of ems dataset.  Note that this selects from disposition_text for narcan (naloxone) usage,
# used to combat fatal heroin overdoses, in addition to incident_type_ids from the data dictionaries.
# Nick also went through manually to confirm that the data dictionary doesn't miss any heroin-related incidents.
heroin_ems <- ems[which(
  str_detect(ems$disposition_text, "NAR") |
    str_detect(ems$disposition_text, "NART") |
    ems$incident_type_id == "HEROINF - FIRE ONLY" |
    ems$incident_type_id == "HEROIN-COMBINED" |
    ems$incident_type_id == "HEROINF-FIRE ONLY" |
    ems$incident_type_id == "HERONF" |
    ems$incident_type_id == "HEORIF"), ] %>% 
  st_as_sf(coords = c("longitude_x", "latitude_x"), crs = 4326, agr = "constant") %>%
  st_transform(3735)

heroin_ems$floor_date <- floor_date(ymd_hms(heroin_ems$create_time_incident, tz = "EST"), unit = "hour") %>% with_tz(tz = "UTC")
weather$floor_date <- ymd_hms(weather$DATE, tz = "UTC") %>% floor_date(unit = "hour")

heroin_ems <- left_join(heroin_ems, 
                        weather %>% 
                          dplyr::mutate(precipitation = HourlyPrecipitation,
                                        temperature = HourlyDryBulbTemperature) %>%
                          dplyr::select(floor_date, temperature, precipitation),
                        by = c("floor_date")
)

heroin_ems15 <- heroin_ems[which(heroin_ems$year == "2015"),]
heroin_ems16 <- heroin_ems[which(heroin_ems$year == "2016"),]
heroin_ems17 <- heroin_ems[which(heroin_ems$year == "2017"),]
heroin_ems18 <- heroin_ems[which(heroin_ems$year == "2018"),]
heroin_ems19 <- heroin_ems[which(heroin_ems$year == "2019"),]

ggplot() +
  geom_sf(data = cincinnati, fill = NA) +
  geom_sf(data = heroin_ems15, size = 1, color = "#8FA108") +
  labs(title="Heroin overdose events 2015", subtitle = "Cincinnati, OH") +
  theme(legend.position = "none") +
  mapTheme()

ggplot() +
  geom_sf(data = cincinnati, fill = NA) +
  geom_sf(data = heroin_ems17, size = 1, color = "#25CB10") +
  labs(title="Heroin overdose events 2017", subtitle = "Cincinnati, OH") +
  theme(legend.position = "none") +
  mapTheme()

ggplot() +
  geom_sf(data = cincinnati, fill = NA) +
  geom_sf(data = heroin_ems19, size = 1, color = "#5AB60C") +
  labs(title="Heroin overdose events 2019", subtitle = "Cincinnati, OH") +
  theme(legend.position = "none") +
  mapTheme()
```

### Features associated with heroin overdose 

The literature on opioid use (e.g., INSERT FOOTNOTES HERE) indicates that several features of a city or neighborhood or street corner's built environment, socioeconomic profile, retail landscape, and crime prevalence are associated with an increased risk of a heroin overdose event. Below is the spatial distribution of these risk factors in Cincinnati specifically.

```{r risk_small_multiples}
# - Vacant, abandoned and condemned buildings
# - 311 non-emergency service requests 
# - Crime (2015-2019)
# - Abandoned vehicles (via zoning code violations data)
# - Land use/zoning
# - Neighborhoods (modified to fit US 2010 census tracts)
# - Locations of fire stations, EMS, police stations, hospitals, pharmacies
# - Locations of firearms and weapons dealers
# - Locations of pool halls, 
# - Female-owned small businesses
# - census
# - ACS
# - temperature
# - precipitation
# - fast food
# 
# ggplot() +
#   geom_sf(data=cincinnati) +
#   geom_sf(data = rbind(abandoned_vehicles %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Abandoned Cars"),
#                        funTimes %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Special Business License"), 
#                        firearms %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Firearms Vendors"),
#                        vacant_buildings %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Vacant, Condemned Bldgs"), 
#                        nalox_sites %>% dplyr::select() %>%
#                          st_transform(st_crs(fishnet)) %>%
#                          mutate(Legend = "Nalox Sites")),
#           size = .1) +
#   facet_wrap(~Legend, ncol = 2) +
#   labs(title = "Risk Factors") +  
#   mapTheme()
# 
# ggplot() +
#   geom_sf(data=cincinnati) +
#   geom_sf(data = rbind(affHousing,abandonBuildings,sanitation,industrial_zones,overdose,
#                        homicide,farmMarket)) +
#         #  size = .1) +
#   facet_wrap(~Legend, ncol = 3) +
#   labs(title = "Spatial Distributuion of Risk Factors") +
#   mapTheme() +
#   theme(strip.text = element_text(size = 5))
```

The maps suggest that only some factors will be useful in predicting heroin overdose risk in Cincinnati, namely, X, Y, and Z, as they demonstrate spatial clustering similar to (or the inverse of) Cincinnati's historic heroin overdose sites. 

The features that do not appear to mimic the spatial process are those derived from 311 non-criminal complaints about abandoned trash and from parking violation data that suggest a car has been abandoned, as well as the locations of firearms dealers. Although abandoned vehicles can serve as drug use sites, they appear to be too prevalent to be of use here, while firearms and weapons retail are too sparse.

These conclusions can be verified by examining the correlation between these features (and different methods of engineering a feature) and the outcome of interest, as below. Firearms dealers are omitted because there are so few data.

```{r correlations}

```

# Spatial/time process 

As can be seen, the temporal process is similar to a negative quadratic function (a parabola that opens downard), while the spatial process displays clustering, most heavily in an arc on the southern side of the city, straddling train tracks and a waterway in south-central Cincinnati. 

To better understand spatial interrelationships between overdoses and related factors, we overlay a grid on the city (referred to as the "fishnet") with 1000-square-foot cells. Using grid cells as a unit of analysis allows us to aggregate factors at hyperlocal geographies. 

```{r spacetime}

```

# Modeling approach

```{r modeling}

```

### Training

```{r training}

```

### Testing

```{r testing}

```

# Cross validation

```{r crossval}

```

# Accuracy

```{r acc}

```

# Generalizability

```{r gen}

```

# Robustness checks

```{r robch}

```

# Improving the distribution of prevention resources in Cincinnati, OH

```{r improvement}

```

# Next steps for model improvement

# Conclusion

# References
[^1]: National Institute on Drug Abuse. (2019). Opioid summaries by state. Accessed from https://www.drugabuse.gov/drugs-abuse/opioids/opioid-summaries-by-state
[^2]: National Institute on Drug Abuse. (2019). Pennsylvania opiod summary. Accessed from https://www.drugabuse.gov/opioid-summaries-by-state/pennsylvania-opioid-summary
[^3]: National Institute on Drug Abuse. (2019). Indiana opiod summary. Accessed from https://www.drugabuse.gov/drugs-abuse/opioids/opioid-summaries-by-state/indiana-opioid-summary
[^4]: Woolf, S.H. & Shoomaker, H. (2019). Life expectancy and mortality rates in the United States, 1959 - 2017. Journal of the American Medical Association, 322(20). 
[^5]: National Institute on Drug Abuse. (2019). Ohio opiod summary. Accessed from https://www.drugabuse.gov/opioid-summaries-by-state/ohio-opioid-summary
[^6]: Ohio Department of Health. (2017). Ohio drug overdose data: general findings. Accessed from https://odh.ohio.gov/wps/wcm/connect/gov/5deb684e-4667-4836-862b-cb5eb59acbd3/2017_OhioDrugOverdoseReport.pdf?MOD=AJPERES&CONVERT_TO=url&CACHEID=ROOTWORKSPACE.Z18_M1HGGIK0N0JO00QO9DDDDM3000-5deb684e-4667-4836-862b-cb5eb59acbd3-moxPbu6
[^7]: Mettler, K. (29 August 2016). 'This is unprecedented:' 174 heroin overdoses in 6 days in Cincinnati. The Washington Post. 
[^8]: City of Cincinnati. (2019). Heroin overdose responses. https://insights.cincinnati-oh.gov/stories/s/Heroin-Overdose-Responses/dm3s-ep3u/
[^9]: Hamilton County Department of Public Health. https://www.hamiltoncountyhealth.org/announcements/deaconess/ 
[^10]: Hamilton County Department of Public Health. https://www.hamiltoncountyhealth.org/harm-reduction/narcan/
[^11]: Ingram, T. (2017). Narcan Distribution Collaborative: Expanding acess in Hamilton County, Ohio and the impacts. Accessed from https://www.naccho.org/uploads/downloadable-resources/49-51-Hamilton-County-Narcan-Distribution-Collaborative.pdf
[^12]: insert citation
[^13]: Li, Z.R., Xie, E., Crawford, F.W., Warren, J.L., McConnell, K., Copple, J.T., Johnson, T., & Gonsalves, G.S. (2019). Suspected heroin-related overdoses incidents in Cincinnati, Ohio: A spatiotemporal analysis. PLOS Medicine, 16(11), pp. 1-15.
[^14]: Bates, S., Leonenko, V., Rineer, J., & Bobashev, G. (2018). Using synthetic populations to understand geospatial patterns in opioid related overdose and predicted opioid misuse. Computational and Mathematical Organization Theory, 25, pp. 25-36.
[^15]: Centers for Disease Control. (2017). Drug overdose deaths. Accessed from https://www.cdc.gov/drugoverdose/data/statedeaths.html
[^16]: Ohio Department of Health. (2018). 2018 Ohio Drug Overdose Data: General FIndings. Accessed from https://odh.ohio.gov/wps/wcm/connect/gov/d9ee6d3b-bf62-4b4f-8978-d7cfcd11348f/2018_OhioDrugOverdoseReport.pdf?MOD=AJPERES&CONVERT_TO=url&CACHEID=ROOTWORKSPACE.Z18_M1HGGIK0N0JO00QO9DDDDM3000-d9ee6d3b-bf62-4b4f-8978-d7cfcd11348f-mXhFqNO; National Institute on Drug Abuse. (2019). Ohio Opioid Summary. Accessed from https://www.drugabuse.gov/opioid-summaries-by-state/ohio-opioid-summary
[17^]: National Institute on Drug Abuse. Ohio Opioid Summary. Accessed from https://www.drugabuse.gov/opioid-summaries-by-state/ohio-opioid-summary